<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoPlaywright - ãƒ†ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            background: #fafafa;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }
        
        .section h2::before {
            content: "âš™ï¸";
            margin-right: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }
        
        input[type="url"], input[type="file"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }
        
        input[type="url"]:focus, input[type="file"]:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .buttons-section h2::before {
            content: "ğŸš€";
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* æœ€åˆã®2è¡Œã¯2åˆ—ã€æœ€å¾Œã®è¡Œã¯1åˆ—ï¼ˆä¸­å¤®é…ç½®ï¼‰ */
        .button-grid button:nth-child(1),
        .button-grid button:nth-child(2) {
            /* æœ€åˆã®è¡Œ */
        }
        
        .button-grid button:nth-child(3),
        .button-grid button:nth-child(4) {
            /* 2è¡Œç›® */
        }
        
        .button-grid button:nth-child(5) {
            /* 3è¡Œç›®ã€ä¸­å¤®é…ç½® */
            grid-column: 2;
        }
        
        button {
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #1abc9c, #16a085);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 188, 156, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
        }
        
        .manual-guide-btn {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .user-story-info {
            margin-top: 5px;
        }
        
        .user-story-id {
            background: linear-gradient(135deg, #e8f5e8, #d1edcc);
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 10px;
            margin-top: 8px;
            color: #2e7d32;
            font-weight: 600;
            text-align: center;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: 600;
            text-align: center;
            max-height: 100px;
            overflow: hidden;
            word-wrap: break-word;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            z-index: 1001;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        
        .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .modal-body {
            padding: 30px;
            line-height: 1.6;
        }
        
        .modal-body h3 {
            color: #2c3e50;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .modal-body h3:first-child {
            margin-top: 0;
        }
        
        .modal-body pre {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            font-size: 14px;
            margin: 15px 0;
        }
        
        .modal-body code {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 2px 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .modal-body ul, .modal-body ol {
            margin: 15px 0;
            padding-left: 25px;
        }
        
        .modal-body li {
            margin-bottom: 8px;
        }
        
        .highlight-box {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        /* ä¿®æ­£ãƒ«ãƒ¼ãƒˆä¸€è¦§ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .fixed-route-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .route-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .route-item h4 {
            margin: 0;
            color: #495057;
            font-size: 14px;
        }

        .route-item p {
            margin: 0;
            font-size: 12px;
            color: #6c757d;
        }

        .route-item button {
            align-self: flex-start;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        /* ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .test-summary {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #28a745;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
        }
        
        .test-summary h3 {
            margin: 0 0 15px 0;
            color: #155724;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #6c757d;
        }
        
        .summary-item.success {
            border-left-color: #28a745;
        }
        
        .summary-item.error {
            border-left-color: #dc3545;
        }
        
        .summary-label {
            font-weight: 600;
            color: #495057;
        }
        
        .summary-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .failed-tests {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .failed-tests h4 {
            margin: 0 0 10px 0;
            color: #721c24;
            font-size: 1rem;
        }
        
        .failed-tests ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        
        .failed-tests li {
            background: white;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            color: #721c24;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9rem;
            line-height: 1.4;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .failed-tests li:last-child {
            margin-bottom: 0;
        }
        
        .failed-tests li::before {
            content: "âŒ ";
            font-weight: bold;
            margin-right: 5px;
        }
        
        /* AIè¨­å®šãƒ‘ãƒãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .ai-config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .ai-config-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .ai-config-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }
        
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #6c757d;
            font-size: 0.85rem;
        }
        
        .form-group input[type="range"] {
            width: 100%;
            margin: 8px 0;
        }
        
        .form-group input[type="number"] {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
            background-color: white;
        }
        
        .form-group select:focus,
        .form-group input[type="number"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 30px;
            gap: 5px;
        }
        
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            color: #007bff;
            background-color: #f8f9fa;
        }
        
        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background-color: #f8f9fa;
        }
        
        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¿ãƒ–ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .selected-story {
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .story-info {
            display: grid;
            gap: 8px;
        }

        .stories-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .story-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .story-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .story-priority {
            font-size: 14px;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 5px;
        }

        .priority-high {
            background: #ffe6e6;
            color: #d63384;
            border: 1px solid #d63384;
        }

        .priority-medium {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .priority-low {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #17a2b8;
        }

        .story-url {
            font-size: 12px;
            color: #6c757d;
            word-break: break-all;
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .file-name {
            font-weight: bold;
            color: #333;
        }

        .file-date {
            font-size: 12px;
            color: #6c757d;
        }

        /* ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£IDãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .user-story-id .btn {
            font-size: 0.75rem;
            padding: 4px 8px;
            margin-left: 10px;
            border: 1px solid #6c757d;
            background-color: transparent;
            color: #6c757d;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .user-story-id .btn:hover {
            background-color: #6c757d;
            color: white;
            border-color: #495057;
        }

        /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®è‰²ã‚’è–„ãã™ã‚‹ */
        input::placeholder,
        textarea::placeholder {
            color: #c6c6c6 !important;
            opacity: 1;
        }
        
        /* Androidå®Ÿæ©Ÿè¨­å®šã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .adb-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .adb-status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .adb-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .adb-status.checking {
            background: #fff3cd;
            color: #856404;
        }
        
        .android-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .android-info h4 {
            margin: 0 0 8px 0;
            color: #1976d2;
        }
        
        .android-info ul {
            margin: 0;
            padding-left: 20px;
            color: #1565c0;
        }
        
        /* Firefoxç”¨ */
        input::-moz-placeholder,
        textarea::-moz-placeholder {
            color: #c6c6c6 !important;
            opacity: 1;
        }
        
        /* WebKitç³»ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ */
        input::-webkit-input-placeholder,
        textarea::-webkit-input-placeholder {
            color: #c6c6c6 !important;
        }
        
        /* Microsoft Edgeç”¨ */
        input::-ms-input-placeholder,
        textarea::-ms-input-placeholder {
            color: #c6c6c6 !important;
        }

        /* ä¸€æ‹¬å®Ÿè¡Œãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .bulk-execution-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .btn-bulk-execution {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            margin-bottom: 10px;
        }

        .btn-bulk-execution:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.4);
        }

        .btn-bulk-execution:active {
            transform: translateY(0);
        }

        .bulk-execution-description {
            color: white;
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
        }

        .bulk-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .bulk-progress {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .progress-step {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .progress-step.active {
            background: #feca57;
            color: #333;
            transform: scale(1.05);
        }

        .progress-step.completed {
            background: #2ecc71;
            color: white;
        }

        .progress-step.error {
            background: #e74c3c;
            color: white;
        }

        .bulk-current-action {
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        /* ä¸€æ‹¬å®Ÿè¡Œã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .bulk-execution-section {
                margin: 15px 0;
                padding: 15px;
            }
            
            .btn-bulk-execution {
                padding: 12px 20px;
                font-size: 16px;
            }
            
            .bulk-execution-description {
                font-size: 12px;
            }
            
            .bulk-progress {
                gap: 8px;
            }
            
            .progress-step {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .bulk-current-action {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AutoPlaywright</h1>
            <p>Playwrightã‚’ä½¿ç”¨ã—ãŸE2Eãƒ†ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«</p>
        </div>
        
        <div class="content">
            <!-- åŸºæœ¬è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå…±é€šï¼‰ -->
            <div class="section">
                <h2>åŸºæœ¬è¨­å®š</h2>
                
                <div class="form-group">
                    <label for="testUrl">ãƒ†ã‚¹ãƒˆå¯¾è±¡URL:</label>
                    <input type="url" id="testUrl" placeholder="https://example.com" value="">
                </div>
                
                <div class="form-group">
                    <label for="testGoal">ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¨ä¸»ãªã‚·ãƒŠãƒªã‚ª:</label>
                    <textarea id="testGoal" rows="3" placeholder="ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼šå®¿æ³Šäºˆç´„ã®å…¥åŠ›ãƒ»é¸æŠãŒã§ãã‚‹&#10;ã‚·ãƒŠãƒªã‚ªï¼šã€å®¿æ³Šäºˆç´„ç”»é¢ã§å„é …ç›®ã«æœ‰åŠ¹ãªå€¤ã‚’å…¥åŠ›ã€ã¾ãŸã¯é¸æŠã—ã¦ã€Œäºˆç´„å†…å®¹ã‚’ç¢ºèªã™ã‚‹ã€ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨ã€ã€Œå®¿æ³Šäºˆç´„ç¢ºèªã€ç”»é¢ã«å€¤ãŒåæ˜ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹"></textarea>
                    <div class="user-story-info">
                        <small>å…·ä½“çš„ãªãƒ†ã‚¹ãƒˆæ‰‹é †ã‚„ç¢ºèªã—ãŸã„å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„</small>
                        
                        <!-- AIä¿®æ­£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
                        <div class="ai-fix-option" style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff;">
                            <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer; font-weight: 500;">
                                <input type="checkbox" id="enableAIFix" style="margin-right: 8px; transform: scale(1.2);">
                                <span>ğŸ¤– å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®ä¿®æ­£ã‚’AIã«ä»»ã›ã‚‹</span>
                            </label>
                            <small style="display: block; margin-top: 5px; color: #6c757d;">
                                ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ä¿®æ­£ã®ã¿ä½¿ç”¨ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ãƒ»å®‰å®šæ€§å‘ä¸Šï¼‰
                            </small>
                        </div>
                        
                        <!-- æ‰‹å‹•ã‚»ãƒ¬ã‚¯ã‚¿æŒ‡å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
                        <div class="manual-selector-option" id="manualSelectorOption" style="display: none; margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer; font-weight: 500;">
                                <input type="checkbox" id="enableManualSelector" style="margin-right: 8px; transform: scale(1.2);">
                                <span>ğŸ¯ è¦ç´ æŒ‡å®šã‚µãƒãƒ¼ãƒˆï¼ˆå¤±æ•—åˆ†ææ™‚ã®ã¿ï¼‰</span>
                            </label>
                            <small style="display: block; margin-top: 5px; color: #856404;">
                                å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®è¦ç´ ã‚’å®Ÿéš›ã®ç”»é¢ã§ç¢ºèªã—ã¦æŒ‡å®šã§ãã¾ã™
                            </small>
                            
                            <div id="manualSelectorDetails" style="display: none; margin-top: 10px;">
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                                    <h5 style="margin: 0 0 8px 0; color: #495057;">ğŸ” è¦ç´ æŒ‡å®šæ–¹æ³•</h5>
                                    <p style="margin: 0; font-size: 13px; color: #6c757d;">
                                        <strong>æ–¹æ³•1: F12ã‚»ãƒ¬ã‚¯ã‚¿ç›´æ¥å…¥åŠ›ï¼ˆæ¨å¥¨ï¼‰</strong><br>
                                        1. è¦ç´ ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€Œæ¤œè¨¼ã€<br>
                                        2. é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§è¦ç´ ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€ŒCopyã€â†’ ã€ŒCopy selectorã€<br>
                                        3. ä¸‹è¨˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘<br><br>
                                        <strong>æ–¹æ³•2: JSONå½¢å¼å…¥åŠ›</strong><br>
                                        å¾“æ¥ã®JSONå½¢å¼ã§ã‚‚å…¥åŠ›å¯èƒ½
                                    </p>
                                </div>
                                
                                <!-- F12ã‚»ãƒ¬ã‚¯ã‚¿ç›´æ¥å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                                <div style="margin-bottom: 15px;">
                                    <label style="font-weight: 500; display: block; margin-bottom: 5px;">
                                        ğŸ¯ F12ã‚»ãƒ¬ã‚¯ã‚¿ç›´æ¥å…¥åŠ›ï¼ˆæ¨å¥¨ï¼‰
                                    </label>
                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <input type="text" id="f12SelectorInput" placeholder="F12ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸã‚»ãƒ¬ã‚¯ã‚¿ã‚’è²¼ã‚Šä»˜ã‘..." 
                                               style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                                        <input type="text" id="f12SelectorLabel" placeholder="è¦ç´ ã®åå‰ï¼ˆä¾‹: æ¸‹è°·ãƒœã‚¿ãƒ³ï¼‰" 
                                               style="width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <button type="button" id="addF12Selector" style="padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            â• è¿½åŠ 
                                        </button>
                                    </div>
                                    <div id="f12SelectorPreview" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; color: #6c757d; min-height: 20px;">
                                        ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢
                                    </div>
                                </div>

                                <label style="font-weight: 500; display: block; margin-bottom: 5px;">
                                    ğŸ“ æ‰‹å‹•ã‚»ãƒ¬ã‚¯ã‚¿è¨­å®šï¼ˆJSONå½¢å¼ï¼‰
                                </label>
                                <textarea id="manualSelectorJson" style="width: 100%; height: 120px; font-family: monospace; font-size: 12px; border: 1px solid #ced4da; border-radius: 4px; padding: 8px;"
                                    placeholder='ä¾‹ï¼ˆF12ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸã‚»ãƒ¬ã‚¯ã‚¿ã‚‚ä½¿ç”¨å¯èƒ½ï¼‰:
{
  "ã‚¨ãƒªã‚¢é¸æŠ": {
    "æ¸‹è°·": "#__next > div:nth-child(2) > main > div > div.shops_inner__g55WC > div > div.shops_columnLeft__Ki5VN > div > div.SearchInput_sort__newQ4 > div.md\\:none > div > div > div > div > div._SearchItem_form__Nx_1C > div:nth-child(11) > div:nth-child(1) > div._SearchItem_itemSub__Y7NMw._SearchItem_areaSub__66bQd > label:nth-child(1)",
    "æµæ¯”å¯¿": "text=æµæ¯”å¯¿"
  },
  "ãƒœã‚¿ãƒ³": {
    "ã“ã®æ¡ä»¶ã§çµã‚Šè¾¼ã‚€": "button:has-text(\"çµã‚Šè¾¼ã‚€\")"
  }
}'></textarea>
                                <div style="margin-top: 8px; display: flex; gap: 10px;">
                                    <button type="button" id="validateSelectors" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px;">
                                        âœ… å½¢å¼ãƒã‚§ãƒƒã‚¯
                                    </button>
                                    <button type="button" id="clearSelectors" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px;">
                                        ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                                    </button>
                                    <button type="button" id="helpSelectors" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px;">
                                        â“ ä½¿ã„æ–¹
                                    </button>
                                </div>
                                <div id="selectorValidationResult" style="margin-top: 8px; font-size: 12px;"></div>
                            </div>
                        </div>
                        
                        <div id="userStoryId" class="user-story-id" style="display: none;">
                            ğŸ”— <strong>ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ID:</strong> <span id="currentUserStoryId">-</span>
                            <button type="button" class="btn" onclick="resetTestHistory()">
                                éå»ã®ãƒ†ã‚¹ãƒˆæƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="csvFile">ãƒ†ã‚¹ãƒˆè¦³ç‚¹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆCSV (ã‚ªãƒ—ã‚·ãƒ§ãƒ³):</label>
                    <input type="file" id="csvFile" accept=".csv">
                    <small>æŒ‡å®šã—ãªã„å ´åˆã¯æ¨™æº–ã®ãƒ†ã‚¹ãƒˆè¦³ç‚¹ã‚’ä½¿ç”¨ã—ã¾ã™</small>
                </div>
                
                <div class="form-group">
                    <label for="pdfFile">ä»•æ§˜æ›¸PDF (ã‚ªãƒ—ã‚·ãƒ§ãƒ³):</label>
                    <input type="file" id="pdfFile" accept=".pdf">
                </div>
            </div>
            
            <!-- å®Ÿè¡Œç’°å¢ƒé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“± å®Ÿè¡Œç’°å¢ƒé¸æŠ</h2>
                
                <div class="form-group">
                    <label for="executionEnvironment">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç’°å¢ƒ:</label>
                    <select id="executionEnvironment" onchange="onEnvironmentChange()">
                        <option value="pc">ğŸ–¥ï¸ PCç‰ˆãƒ–ãƒ©ã‚¦ã‚¶ (æ¨™æº–)</option>
                        <option value="android">ğŸ“± Androidå®Ÿæ©Ÿ (CDPæ¥ç¶š)</option>
                    </select>
                    <small>Androidå®Ÿæ©Ÿã‚’é¸æŠã™ã‚‹å ´åˆã¯ã€äº‹å‰ã«ADBãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã®è¨­å®šãŒå¿…è¦ã§ã™</small>
                </div>
                
                <!-- Androidå®Ÿæ©Ÿå°‚ç”¨è¨­å®š -->
                <div id="androidSettings" style="display: none;">
                    <div class="form-group">
                        <label for="domAnalysisSource">DOMè§£æå…ƒ:</label>
                        <select id="domAnalysisSource">
                            <option value="pc">ğŸ–¥ï¸ PCç‰ˆã§è§£æ (æ¨å¥¨)</option>
                            <option value="android">ğŸ“± Androidå®Ÿæ©Ÿã§è§£æ</option>
                        </select>
                        <small>PCç‰ˆã®æ–¹ãŒè¦ç´ æ¤œå‡ºãŒå®‰å®šã—ã¦ã„ã¾ã™</small>
                    </div>
                    
                    <div class="form-group">
                        <label>ADBæ¥ç¶šç¢ºèª:</label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
                            <button type="button" class="btn-info" onclick="checkADBConnection()" style="padding: 8px 16px; font-size: 14px;">
                                ğŸ” æ¥ç¶šç¢ºèª
                            </button>
                            <button type="button" class="btn-secondary" onclick="setupADBForward()" style="padding: 8px 16px; font-size: 14px;">
                                ğŸ”§ ADBè¨­å®š
                            </button>
                            <div id="adbStatus" class="adb-status" style="font-size: 14px; font-weight: 600;"></div>
                        </div>
                        <small>Androidå®Ÿæ©Ÿã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„</small>
                    </div>
                    
                    <div class="android-info" style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin: 15px 0; border-radius: 0 8px 8px 0;">
                        <h4 style="margin: 0 0 8px 0; color: #1976d2;">ğŸ“± Androidå®Ÿæ©Ÿãƒ†ã‚¹ãƒˆã®ç‰¹å¾´</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #1565c0;">
                            <li>ã‚¹ãƒãƒ›ç‰ˆUIã«ç‰¹åŒ–ã—ãŸè¦ç´ æ¤œå‡º</li>
                            <li>å®Ÿéš›ã®ã‚¿ãƒƒãƒæ“ä½œã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆ</li>
                            <li>PCç‰ˆã¨ã¯ç•°ãªã‚‹UIæ§‹é€ ã«å¯¾å¿œ</li>
                            <li>è¡¨ç¤ºç¢ºèªãƒ†ã‚¹ãƒˆãŒæœ€ã‚‚å®‰å®š</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- ä¸€æ‹¬å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
            <div class="bulk-execution-section">
                <button class="btn-bulk-execution" onclick="executeBulkWorkflow()">
                    ğŸš€ è‡ªå‹•ã§ä¸€æ‹¬å®Ÿè¡Œã™ã‚‹
                </button>
                <div class="bulk-execution-description">
                    è¦³ç‚¹ç”Ÿæˆ â†’ ã‚·ãƒŠãƒªã‚ªç”Ÿæˆ â†’ Playwrightç”¨ã«å¤‰æ› â†’ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ â†’ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ â†’ å¤±æ•—åˆ†æ â†’ å†ãƒˆãƒ©ã‚¤ â†’ æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç™ºè¦‹ã‚’è‡ªå‹•å®Ÿè¡Œ
                </div>
                
                <!-- ä¸€æ‹¬å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div id="bulkStatus" class="bulk-status" style="display: none;">
                    <div class="bulk-progress">
                        <div class="progress-step" id="step-testpoints">ğŸ“‹ è¦³ç‚¹ç”Ÿæˆ</div>
                        <div class="progress-step" id="step-testcases">ğŸ§  ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç”Ÿæˆ</div>
                        <div class="progress-step" id="step-routes">ğŸ­ Playwrightç”¨ã«å¤‰æ›</div>
                        <div class="progress-step" id="step-run">â–¶ï¸ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</div>
                        <div class="progress-step" id="step-report">ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</div>
                        <div class="progress-step" id="step-analyze">ğŸ”§ å¤±æ•—åˆ†æ</div>
                        <div class="progress-step" id="step-retry">ğŸš€ å†ãƒˆãƒ©ã‚¤</div>
                        <div class="progress-step" id="step-stories">ğŸ” æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç™ºè¦‹</div>
                    </div>
                    <div class="bulk-current-action" id="bulkCurrentAction">æº–å‚™ä¸­...</div>
                </div>
            </div>
            
            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="tab-nav">
                <button class="tab-button active" onclick="switchTab('test-execution')">ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button class="tab-button" onclick="switchTab('auto-improvement')">ğŸ¤– è‡ªå‹•æ”¹å–„ãƒ»å­¦ç¿’æ©Ÿèƒ½</button>
                <button class="tab-button" onclick="switchTab('new-stories')">ğŸ“– æ–°ã—ã„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</button>
            </div>
            
            <!-- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¿ãƒ– -->
            <div id="test-execution" class="tab-content active">
                <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="section buttons-section">
                <h2>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
                
                <div class="button-grid">
                    <button class="btn-primary" onclick="executeCommand('generateTestPoints')">
                        ğŸ“‹ ãƒ†ã‚¹ãƒˆè¦³ç‚¹ç”Ÿæˆ
                    </button>
                    
                    <button class="btn-secondary" onclick="executeCommand('generateTestCases')" title="ãƒ†ã‚¹ãƒˆè¦³ç‚¹ã‚’ã‚ˆã‚Šå…·ä½“çš„ãªè‡ªç„¶è¨€èªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«ç”Ÿæˆ">
                        ğŸ§  ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç”Ÿæˆ
                    </button>
                    
                    <button class="btn-info" onclick="executeCommand('generateSmartScenariosAll')" title="å…¨ã‚«ãƒ†ã‚´ãƒªï¼ˆè¡¨ç¤ºãƒ»å…¥åŠ›ï¼‰ã®ãƒ«ãƒ¼ãƒˆã‚’ä¸€æ‹¬ç”Ÿæˆ">
                        ğŸ­ Playwrightç”¨ã«å¤‰æ›
                    </button>
                    
                    <button class="btn-success" onclick="executeCommand('runBatchSequential')" title="è¡¨ç¤ºâ†’å…¥åŠ›ã®é †ç•ªã§å…¨ã‚«ãƒ†ã‚´ãƒªã‚’è‡ªå‹•å®Ÿè¡Œ">
                        ğŸš€ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                    </button>
                    
                    <button class="btn-warning" onclick="executeCommand('generateTestReport')">
                        ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
                    </button>
                </div>
                

                
                <div id="status" class="status" style="display: none;"></div>
                
                <!-- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼ -->
                <div id="testSummary" class="test-summary" style="display: none;">
                    <h3>ğŸ“Š ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span class="summary-label">ğŸ”· ãƒ†ã‚¹ãƒˆID:</span>
                            <span id="testId" class="summary-value">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">ğŸ”· ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°:</span>
                            <span id="totalSteps" class="summary-value">-</span>
                        </div>
                        <div class="summary-item success">
                            <span class="summary-label">âœ… æˆåŠŸæ•°:</span>
                            <span id="successCount" class="summary-value">-</span>
                        </div>
                        <div class="summary-item error">
                            <span class="summary-label">âŒ å¤±æ•—æ•°:</span>
                            <span id="failureCount" class="summary-value">-</span>
                        </div>
                    </div>
                    <div id="failedTests" class="failed-tests" style="display: none;">
                        <h4>âŒ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹:</h4>
                        <ul id="failedTestsList"></ul>
                    </div>
                </div>
                
                <div class="log-area" id="logArea">
                    å®Ÿè¡Œãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
                </div>
            </div>
            
            <!-- AIè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ¤– AIè¨­å®š</h2>
                
                <div class="ai-config-grid">
                    <div class="form-group">
                        <label for="aiModel">ãƒ¢ãƒ‡ãƒ«:</label>
                        <select id="aiModel">
                            <option value="gpt-4o-mini">GPT-4o Mini (æ¨å¥¨)</option>
                            <option value="gpt-4o">GPT-4o</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="aiTemperature">å‰µé€ æ€§ (Temperature): <span id="temperatureValue">0.5</span></label>
                        <input type="range" id="aiTemperature" min="0" max="1" step="0.1" value="0.5">
                        <small>0.0: æ±ºå®šçš„, 1.0: å‰µé€ çš„</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="aiMaxTokens">æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°:</label>
                        <input type="number" id="aiMaxTokens" min="1000" max="8000" step="500" value="4000">
                        <small>1000-8000 (å¤šã„ã»ã©è©³ç´°ãªå›ç­”)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="aiTopP">Top-p: <span id="topPValue">0.9</span></label>
                        <input type="range" id="aiTopP" min="0.1" max="1" step="0.1" value="0.9">
                        <small>0.1: é›†ä¸­çš„, 1.0: å¤šæ§˜æ€§</small>
                    </div>
                </div>
                
                <div class="ai-config-actions">
                    <button type="button" class="btn-secondary" onclick="resetAIConfig()">
                        ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
                    </button>
                    <button type="button" class="btn-primary" onclick="saveAIConfig()">
                        ğŸ’¾ è¨­å®šã‚’ä¿å­˜
                    </button>
                </div>
            </div>

            
                <!-- æ‰‹å‹•ã‚¬ã‚¤ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="section">
                    <h2>ğŸ“‹ æ‰‹å‹•ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªä½œæˆ</h2>
                    
                    <div class="form-group">
                        <button type="button" class="btn-info manual-guide-btn" onclick="showManualGuide()">
                            ğŸ“‹ æ‰‹å‹•ã§ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã‚’ä½œæˆã™ã‚‹æ–¹æ³•
                        </button>
                        <small>AIãŒç”Ÿæˆã™ã‚‹ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã«æº€è¶³ã§ããªã„å ´åˆã®ä»£æ›¿æ‰‹æ®µ</small>
                    </div>
                </div>
            </div>
            
            <!-- è‡ªå‹•æ”¹å–„ãƒ»å­¦ç¿’æ©Ÿèƒ½ã‚¿ãƒ– -->
            <div id="auto-improvement" class="tab-content">
                <!-- è‡ªå‹•æ”¹å–„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="section">
                    <h2>ğŸ§  è‡ªå‹•æ”¹å–„ãƒ»å­¦ç¿’æ©Ÿèƒ½</h2>
                    
                    <div class="button-container">
                        <button class="btn btn-warning" onclick="executeCommand('analyzeFailures')">
                            ğŸ”§ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®åˆ†æã¨ä¿®æ­£
                        </button>
                        <button class="btn btn-success" onclick="showFixedRouteModal()">
                            ğŸš€ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®å†ãƒˆãƒ©ã‚¤
                        </button>
                    </div>
                    
                    <div id="statusAI" class="status" style="display: none;"></div>
                    
                    <!-- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼ï¼ˆè‡ªå‹•æ”¹å–„ç”¨ï¼‰ -->
                    <div id="testSummaryAI" class="test-summary" style="display: none;">
                        <h3>ğŸ“Š è‡ªå‹•æ”¹å–„å®Ÿè¡Œçµæœ</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <span class="summary-label">ğŸ”· ãƒ†ã‚¹ãƒˆID:</span>
                                <span id="testIdAI" class="summary-value">-</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">ğŸ”· ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°:</span>
                                <span id="totalStepsAI" class="summary-value">-</span>
                            </div>
                            <div class="summary-item success">
                                <span class="summary-label">âœ… æˆåŠŸæ•°:</span>
                                <span id="successCountAI" class="summary-value">-</span>
                            </div>
                            <div class="summary-item error">
                                <span class="summary-label">âŒ å¤±æ•—æ•°:</span>
                                <span id="failureCountAI" class="summary-value">-</span>
                            </div>
                        </div>
                        <div id="failedTestsAI" class="failed-tests" style="display: none;">
                            <h4>âŒ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹:</h4>
                            <ul id="failedTestsListAI"></ul>
                        </div>
                    </div>
                    
                    <div class="log-area" id="logAreaAI">
                        è‡ªå‹•æ”¹å–„å®Ÿè¡Œãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
                    </div>
                    
                    <div class="description">
                        <h4>ğŸ¤– å­¦ç¿’æ©Ÿèƒ½ã®ç‰¹å¾´:</h4>
                        <ul>
                            <li><strong>å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³å­¦ç¿’</strong>: éå»ã®å¤±æ•—ã‚’è¨˜éŒ²ã—ã€åŒã˜ãƒŸã‚¹ã‚’å›é¿</li>
                            <li><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å‚ç…§</strong>: ä¸Šè¨˜ã§å…¥åŠ›ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’è€ƒæ…®ã—ã¦é‡è¦ãªè¦ç´ ã‚’ç‰¹å®š</li>
                            <li><strong>ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¿®æ­£</strong>: PDFä»•æ§˜æ›¸ã‚„CSVè¦³ç‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‚ç…§ã—ã¦é©åˆ‡ãªä¿®æ­£ã‚’ææ¡ˆ</li>
                            <li><strong>ä»£æ›¿ã‚»ãƒ¬ã‚¯ã‚¿ææ¡ˆ</strong>: è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ä»£æ›¿æ¡ˆã‚’ç”Ÿæˆ</li>
                            <li><strong>ä¿®æ­£ã‚·ãƒŠãƒªã‚ªç”Ÿæˆ</strong>: å¤±æ•—åŸå› ã‚’è§£æã—ã€ä¿®æ­£ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•ä½œæˆ</li>
                        </ul>
                        <div class="highlight-box">
                            <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> å¤±æ•—åˆ†æå®Ÿè¡Œæ™‚ã«ä¸Šè¨˜ã®ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼/ãƒ†ã‚¹ãƒˆç›®æ¨™ã€ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°ã€
                            ãã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®è¦³ç‚¹ã‹ã‚‰é‡è¦ãªè¦ç´ ã‚’åˆ¤å®šã—ã€ã‚¹ã‚­ãƒƒãƒ—ã§ã¯ãªãä»£æ›¿æ‰‹æ®µã‚’æ¨¡ç´¢ã—ã¾ã™ï¼
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ–°ã—ã„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¿ãƒ– -->
            <div id="new-stories" class="tab-content">
                <!-- æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç™ºè¦‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="section">
                    <h2>ğŸ“– æ–°ã—ã„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç™ºè¦‹ãƒ»å®Ÿè¡Œ</h2>
                    
                    <div class="button-container">
                        <button class="btn btn-info" onclick="executeCommand('discoverNewStories')">
                            ğŸ” æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç™ºè¦‹
                        </button>
                        <button class="btn btn-success" onclick="showDiscoveredStoriesModal()">
                            ğŸ“‹ ç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é¸æŠ
                        </button>
                    </div>
                    
                    <div id="statusNewStories" class="status" style="display: none;"></div>
                    
                    <!-- é¸æŠã•ã‚ŒãŸã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¡¨ç¤º -->
                    <div id="selectedStoryDisplay" class="selected-story" style="display: none;">
                        <h3>ğŸ¯ é¸æŠã•ã‚ŒãŸã‚¹ãƒˆãƒ¼ãƒªãƒ¼</h3>
                        <div class="story-info">
                            <p><strong>ã‚¹ãƒˆãƒ¼ãƒªãƒ¼:</strong> <span id="selectedStoryText">-</span></p>
                            <p><strong>å„ªå…ˆåº¦:</strong> <span id="selectedStoryPriority">-</span></p>
                            <p><strong>æ¨å¥¨URL:</strong> <span id="selectedStoryUrl">-</span></p>
                        </div>
                    </div>
                    
                    <!-- æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒœã‚¿ãƒ³ -->
                    <div class="section">
                        <h3>ğŸš€ æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h3>
                        <div class="button-container">
                            <button class="btn btn-primary" onclick="executeNewStoryCommand('generateTestPoints')">
                                ğŸ“ ãƒ†ã‚¹ãƒˆè¦³ç‚¹ç”Ÿæˆ
                            </button>
                            <button class="btn btn-secondary" onclick="executeNewStoryCommand('generateTestCases')">
                                ğŸ§  ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç”Ÿæˆ
                            </button>
                            <button class="btn btn-success" onclick="executeNewStoryCommand('runBatchSequential')" title="è¡¨ç¤ºâ†’å…¥åŠ›ã®é †ç•ªã§å…¨ã‚«ãƒ†ã‚´ãƒªã‚’è‡ªå‹•å®Ÿè¡Œ">
                                ğŸš€ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                            </button>
                            <button class="btn btn-warning" onclick="executeNewStoryCommand('generateTestReport')">
                                ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
                            </button>
                        </div>
                    </div>
                    
                    <!-- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼ï¼ˆæ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”¨ï¼‰ -->
                    <div id="testSummaryNewStories" class="test-summary" style="display: none;">
                        <h3>ğŸ“Š æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ã‚¹ãƒˆçµæœ</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <span class="summary-label">ğŸ”· ãƒ†ã‚¹ãƒˆID:</span>
                                <span id="testIdNewStories" class="summary-value">-</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">ğŸ”· ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°:</span>
                                <span id="totalStepsNewStories" class="summary-value">-</span>
                            </div>
                            <div class="summary-item success">
                                <span class="summary-label">âœ… æˆåŠŸæ•°:</span>
                                <span id="successCountNewStories" class="summary-value">-</span>
                            </div>
                            <div class="summary-item error">
                                <span class="summary-label">âŒ å¤±æ•—æ•°:</span>
                                <span id="failureCountNewStories" class="summary-value">-</span>
                            </div>
                        </div>
                        <div id="failedTestsNewStories" class="failed-tests" style="display: none;">
                            <h4>âŒ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹:</h4>
                            <ul id="failedTestsListNewStories"></ul>
                        </div>
                    </div>
                    
                    <div class="log-area" id="logAreaNewStories">
                        æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
                    </div>
                    
                    <div class="description">
                        <h4>ğŸ“– æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ©Ÿèƒ½ã®ç‰¹å¾´:</h4>
                        <ul>
                            <li><strong>ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è‡ªå‹•ç™ºè¦‹</strong>: éå»ã®ãƒ†ã‚¹ãƒˆçµæœã‚’åˆ†æã—ã¦æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç™ºè¦‹</li>
                            <li><strong>å„ªå…ˆåº¦åˆ¤å®š</strong>: AIãŒé‡è¦åº¦ã‚’åˆ¤å®šã—ã€é«˜å„ªå…ˆåº¦ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å„ªå…ˆè¡¨ç¤º</li>
                            <li><strong>ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹å®Ÿè¡Œ</strong>: ç™ºè¦‹ã•ã‚ŒãŸã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ãã®ã¾ã¾æ–°ã—ã„ãƒ†ã‚¹ãƒˆã¨ã—ã¦å®Ÿè¡Œ</li>
                            <li><strong>å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</strong>: è¦³ç‚¹ç”Ÿæˆâ†’ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç”Ÿæˆâ†’Playwrightå¤‰æ›â†’å®Ÿè¡Œâ†’ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã¾ã§ä¸€è²«ã—ãŸå®Ÿè¡ŒãŒå¯èƒ½</li>
                        </ul>
                        <div class="highlight-box">
                            <strong>ğŸ’¡ ä½¿ã„æ–¹:</strong> 
                            1. ã€Œæ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç™ºè¦‹ã€ã§æ–°ã—ã„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç™ºè¦‹ â†’ 
                            2. ã€Œç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é¸æŠã€ã§ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’é¸æŠ â†’ 
                            3. è¦³ç‚¹ç”Ÿæˆâ†’ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç”Ÿæˆâ†’å¤‰æ›â†’å®Ÿè¡Œã®é †ç•ªã§å®Ÿè¡Œï¼
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰‹å‹•ã‚¬ã‚¤ãƒ‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="manualGuideModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>ğŸ“‹ æ‰‹å‹•ã§ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã‚’ä½œæˆã™ã‚‹æ–¹æ³•</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <h3>ğŸ¯ æ¦‚è¦</h3>
                <p>AIãŒç”Ÿæˆã™ã‚‹ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã«æº€è¶³ã§ããªã„å ´åˆã€æ‰‹å‹•ã§JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã‚ˆã‚Šç²¾å¯†ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚</p>
                
                <div class="highlight-box">
                    <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> æ‰‹å‹•ä½œæˆã«ã‚ˆã‚Šã€AIã§ã¯å¯¾å¿œã§ããªã„è¤‡é›‘ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã‚„ç‰¹å®šã®è¦ç´ ã‚’æ­£ç¢ºã«ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚
                </div>

                <h3>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®å ´æ‰€</h3>
                <p>ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ‰‹å‹•ã§JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š</p>
                <pre><code>test-results/route_yymmddhhmmss.json</code></pre>
                <p>ãƒ•ã‚¡ã‚¤ãƒ«åã®å½¢å¼ï¼š<code>route_</code> + å¹´æœˆæ—¥æ™‚åˆ†ç§’ + <code>.json</code></p>
                <p>ä¾‹ï¼š<code>route_250623145230.json</code> (2025å¹´06æœˆ23æ—¥ 14æ™‚52åˆ†30ç§’)</p>

                <h3>ğŸ“ JSONæ§‹é€ </h3>
                <p>ä»¥ä¸‹ã®æ§‹é€ ã§JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š</p>
                <pre><code>{
  "scenario_id": "scenario_manual_test_001",
  "route_id": "manual_test_001",
  "steps": [
    {
      "label": "ã‚¹ãƒ†ãƒƒãƒ—ã®èª¬æ˜",
      "action": "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å",
      "target": "ã‚»ãƒ¬ã‚¯ã‚¿ã¾ãŸã¯URL",
      "value": "å…¥åŠ›å€¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
    }
  ]
}</code></pre>

                <h3>ğŸ”§ åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                <ul>
                    <li><code>load</code> - ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€</li>
                    <li><code>click</code> - è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹</li>
                    <li><code>fill</code> - å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’å…¥åŠ›ã™ã‚‹</li>
                    <li><code>assertVisible</code> - è¦ç´ ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹</li>
                    <li><code>assertNotVisible</code> - è¦ç´ ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹</li>
                    <li><code>waitForSelector</code> - è¦ç´ ãŒç¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹</li>
                    <li><code>waitForURL</code> - ç‰¹å®šã®URLã«é·ç§»ã™ã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹</li>
                </ul>

                <h3>ğŸ“‹ å®Œå…¨ãªä¾‹</h3>
                <pre><code>{
  "scenario_id": "scenario_manual_login_test",
  "route_id": "manual_login_test",
  "steps": [
    {
      "label": "ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’é–‹ã",
      "action": "load",
      "target": "https://example.com/login"
    },
    {
      "label": "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›",
      "action": "fill",
      "target": "input[name='username']",
      "value": "testuser"
    },
    {
      "label": "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›",
      "action": "fill",
      "target": "input[name='password']",
      "value": "testpass123"
    },
    {
      "label": "ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯",
      "action": "click",
      "target": "button[type='submit']"
    },
    {
      "label": "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã«é·ç§»ç¢ºèª",
      "action": "waitForURL",
      "target": "**/dashboard**"
    },
    {
      "label": "ã‚ˆã†ã“ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª",
      "action": "assertVisible",
      "target": ".welcome-message"
    }
  ]
}</code></pre>

                <h3>âš ï¸ æ³¨æ„äº‹é …</h3>
                <div class="warning-box">
                    <ul>
                        <li>JSONã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„</li>
                        <li>ã‚»ãƒ¬ã‚¯ã‚¿ã¯å®Ÿéš›ã«ãƒšãƒ¼ã‚¸ã«å­˜åœ¨ã™ã‚‹è¦ç´ ã‚’æŒ‡å®šã—ã¦ãã ã•ã„</li>
                        <li>è¤‡æ•°ã®å€™è£œã‚»ãƒ¬ã‚¯ã‚¿ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§æŒ‡å®šã§ãã¾ã™ï¼ˆä¾‹ï¼š<code>"h1, .title, #main-title"</code>ï¼‰</li>
                        <li>ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å¾Œã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒœã‚¿ãƒ³ã§è‡ªå‹•çš„ã«æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã™</li>
                    </ul>
                </div>

                <h3>ğŸ” ã‚»ãƒ¬ã‚¯ã‚¿ã®ã‚³ãƒ„</h3>
                <ul>
                    <li><strong>F12ã‚³ãƒ”ãƒ¼ï¼ˆæ¨å¥¨ï¼‰:</strong> é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§è¦ç´ ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ Copy â†’ Copy selector</li>
                    <li><strong>IDé¸æŠ:</strong> <code>#element-id</code></li>
                    <li><strong>ã‚¯ãƒ©ã‚¹é¸æŠ:</strong> <code>.class-name</code></li>
                    <li><strong>å±æ€§é¸æŠ:</strong> <code>input[type="email"]</code></li>
                    <li><strong>ãƒ†ã‚­ã‚¹ãƒˆé¸æŠ:</strong> <code>text=ãƒ­ã‚°ã‚¤ãƒ³</code></li>
                    <li><strong>è¤‡åˆé¸æŠ:</strong> <code>form input[type="submit"]</code></li>
                    <li><strong>è¤‡æ•°å€™è£œ:</strong> <code>button, .btn, [type="submit"]</code></li>
                </ul>

                <div class="highlight-box">
                    <strong>ğŸš€ ãƒ—ãƒ­ã®ã‚³ãƒ„:</strong> F12ã®ã€ŒCopy selectorã€æ©Ÿèƒ½ã‚’ä½¿ãˆã°ã€è¤‡é›‘ãªã‚»ãƒ¬ã‚¯ã‚¿ã‚‚ç°¡å˜ã«å–å¾—ã§ãã¾ã™ï¼ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–‡å­—ã‚‚è‡ªå‹•å‡¦ç†ã•ã‚Œã‚‹ã®ã§å®‰å¿ƒã§ã™ã€‚
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ­£ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="fixedRouteModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>ğŸš€ ä¿®æ­£ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œ</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <h3>ğŸ¯ æ¦‚è¦</h3>
                <p>å¤±æ•—åˆ†æã§ç”Ÿæˆã•ã‚ŒãŸä¿®æ­£ã‚·ãƒŠãƒªã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚</p>
                
                <div class="highlight-box">
                    <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> ä¿®æ­£ã‚·ãƒŠãƒªã‚ªï¼ˆfixed_*ï¼‰ã¯å…ƒã®ãƒ†ã‚¹ãƒˆã®å¤±æ•—ã‚’æ”¹å–„ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™ã€‚
                </div>

                <h3>ğŸ“‹ ä¿®æ­£ã‚·ãƒŠãƒªã‚ªãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h3>
                <div id="fixedRouteList">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>

                <h3>âš ï¸ æ³¨æ„äº‹é …</h3>
                <div class="warning-box">
                    <ul>
                        <li>ä¿®æ­£ã‚·ãƒŠãƒªã‚ªã¯å…ƒã®ãƒ†ã‚¹ãƒˆã®å¤±æ•—ã‚’è§£æ±ºã™ã‚‹ç›®çš„ã§ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™</li>
                        <li>ä¸€éƒ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒã€Œã‚¹ã‚­ãƒƒãƒ—ã€ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</li>
                        <li>ä¿®æ­£æˆåŠŸç‡ã¯100%ã§ã¯ã‚ã‚Šã¾ã›ã‚“</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="discoveredStoriesModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>ğŸ“– ç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é¸æŠ</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <h3>ğŸ¯ æ¦‚è¦</h3>
                <p>éå»ã«ç™ºè¦‹ã•ã‚ŒãŸæ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®ä¸€è¦§ã‹ã‚‰é¸æŠã—ã¾ã™ã€‚</p>
                
                <div class="highlight-box">
                    <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> é¸æŠã—ãŸã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãŒåŸºæœ¬è¨­å®šã®ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã€æ¬„ã«è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚
                </div>

                <h3>ğŸ“‹ ç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ä¸€è¦§</h3>
                <div id="discoveredStoriesList">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>

                <h3>âš ï¸ æ³¨æ„äº‹é …</h3>
                <div class="warning-box">
                    <ul>
                        <li>ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’é¸æŠã™ã‚‹ã¨åŸºæœ¬è¨­å®šã®å†…å®¹ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™</li>
                        <li>æ¨å¥¨URLãŒã‚ã‚‹å ´åˆã¯ã€ãã®URLã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™</li>
                        <li>é¸æŠå¾Œã¯ã€Œæ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã€ã‚¿ãƒ–ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒå¯èƒ½ã§ã™</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒãƒƒãƒçµæœè©³ç´°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="batch-details-area" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid #007bff;">
        <div id="batch-details-content">
            <!-- ãƒãƒƒãƒçµæœè©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="story-mapping-area" style="display: none; margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 10px; border: 2px solid #ffc107;">
        <div id="story-mapping-content">
            <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <script>
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function switchTab(tabId) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è§£é™¤
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // å¯¾å¿œã™ã‚‹ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            const targetButton = document.querySelector(`[onclick="switchTab('${tabId}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }
        
        // ãƒ­ã‚°ã‚¨ãƒªã‚¢ã«è¿½åŠ ã™ã‚‹é–¢æ•°
        function addLog(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logArea.textContent += logMessage;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // è‡ªå‹•æ”¹å–„ã‚¿ãƒ–ç”¨ã®ãƒ­ã‚°é–¢æ•°
        function addLogAI(message, type = 'info') {
            const logArea = document.getElementById('logAreaAI');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logArea.textContent += logMessage;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œF12ã‚­ãƒ¼æ©Ÿèƒ½
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12') {
                e.preventDefault();
                
                // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—ã‚’æ¤œå‡º
                const viewport = window.innerWidth;
                const deviceType = viewport < 768 ? 'mobile' : 'desktop';
                
                console.log(`ğŸ“± ç¾åœ¨ã®ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—: ${deviceType} (å¹…: ${viewport}px)`);
                
                // ãƒã‚¦ã‚¹ä½ç½®ã‹ã‚‰è¦ç´ ã‚’å–å¾—
                const element = document.elementFromPoint(window.lastMouseX || 0, window.lastMouseY || 0);
                if (element) {
                    const selectors = generateResponsiveSelectors(element, deviceType);
                    console.log('ğŸ¯ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã‚»ãƒ¬ã‚¯ã‚¿:', selectors);
                    
                    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                    const selectorText = selectors.map((sel, i) => `${i + 1}. ${sel}`).join('\n');
                    navigator.clipboard.writeText(selectorText).then(() => {
                        alert(`ğŸ“± ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã‚»ãƒ¬ã‚¯ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸï¼\n\nãƒ‡ãƒã‚¤ã‚¹: ${deviceType}\n\n${selectorText}\n\nâœ… ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼æ¸ˆã¿`);
                    });
                }
            }
        });
        
        // ãƒã‚¦ã‚¹ä½ç½®ã‚’è¿½è·¡
        document.addEventListener('mousemove', function(e) {
            window.lastMouseX = e.clientX;
            window.lastMouseY = e.clientY;
        });
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã‚»ãƒ¬ã‚¯ã‚¿ç”Ÿæˆé–¢æ•°
        function generateResponsiveSelectors(element, deviceType) {
            const selectors = [];
            
            // åŸºæœ¬ã‚»ãƒ¬ã‚¯ã‚¿
            if (element.id) selectors.push(`#${element.id}`);
            if (element.name) selectors.push(`[name="${element.name}"]`);
            
            // ã‚¯ãƒ©ã‚¹ãƒ™ãƒ¼ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼‰
            if (element.className) {
                const classes = element.className.split(' ').filter(c => c.trim());
                classes.forEach(cls => {
                    if (cls.includes('_') && !cls.includes('md:')) {
                        selectors.push(`[class*="${cls}"]`);
                    }
                });
            }
            
            // ãƒ‡ãƒã‚¤ã‚¹å›ºæœ‰ã‚»ãƒ¬ã‚¯ã‚¿
            if (deviceType === 'mobile') {
                // ã‚¹ãƒãƒ›ç‰ˆã§ã¯ã€PCå°‚ç”¨ã‚¯ãƒ©ã‚¹ã‚’é™¤å¤–
                selectors.push(`${element.tagName.toLowerCase()}:not([class*="md:"])`);
            } else {
                // PCç‰ˆã§ã¯ã€è©³ç´°ãªãƒ‘ã‚¹ã‚’å«ã‚ã‚‹
                const fullPath = generateFullPath(element);
                if (fullPath) selectors.push(fullPath);
            }
            
            // ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿
            if (element.textContent) {
                const text = element.textContent.trim();
                if (text.length > 0 && text.length < 50) {
                    selectors.push(`text="${text}"`);
                    selectors.push(`${element.tagName.toLowerCase()}:has-text("${text}")`);
                }
            }
            
            // è¦ç´ ã‚¿ã‚¤ãƒ—åˆ¥ã‚»ãƒ¬ã‚¯ã‚¿
            if (element.tagName.toLowerCase() === 'select') {
                selectors.push(`select[name="${element.name}"]`);
            } else if (element.tagName.toLowerCase() === 'input') {
                if (element.type) {
                    selectors.push(`input[type="${element.type}"]`);
                }
            } else if (element.tagName.toLowerCase() === 'button') {
                selectors.push(`button:visible`);
            }
            
            return selectors.filter(s => s && s.length > 0);
        }
        
        // å®Œå…¨ãƒ‘ã‚¹ç”Ÿæˆé–¢æ•°
        function generateFullPath(element) {
            const path = [];
            let current = element;
            
            while (current && current.tagName && path.length < 5) {
                let selector = current.tagName.toLowerCase();
                
                if (current.id) {
                    selector += `#${current.id}`;
                    path.unshift(selector);
                    break;
                }
                
                if (current.className) {
                    const classes = current.className.split(' ').filter(c => c.trim());
                    if (classes.length > 0) {
                        selector += '.' + classes.join('.');
                    }
                }
                
                // nth-child ã®è¿½åŠ 
                if (current.parentNode) {
                    const siblings = Array.from(current.parentNode.children);
                    const sameTagSiblings = siblings.filter(s => s.tagName === current.tagName);
                    if (sameTagSiblings.length > 1) {
                        const index = sameTagSiblings.indexOf(current) + 1;
                        selector += `:nth-child(${index})`;
                    }
                }
                
                path.unshift(selector);
                current = current.parentNode;
            }
            
            return path.join(' > ');
        }
        
        // æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¿ãƒ–ç”¨ã®ãƒ­ã‚°é–¢æ•°
        function addLogNewStories(message, type = 'info') {
            const logArea = document.getElementById('logAreaNewStories');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logArea.textContent += logMessage;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºé–¢æ•°
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            // é•·ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯çŸ­ç¸®ã—ã¦è¡¨ç¤º
            const displayMessage = message.length > 100 ? message.substring(0, 100) + '...' : message;
            statusEl.textContent = displayMessage;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }
        
        // è‡ªå‹•æ”¹å–„ã‚¿ãƒ–ç”¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºé–¢æ•°
        function showStatusAI(message, type) {
            const statusEl = document.getElementById('statusAI');
            // é•·ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯çŸ­ç¸®ã—ã¦è¡¨ç¤º
            const displayMessage = message.length > 100 ? message.substring(0, 100) + '...' : message;
            statusEl.textContent = displayMessage;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }
        
        // æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¿ãƒ–ç”¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºé–¢æ•°
        function showStatusNewStories(message, type) {
            const statusEl = document.getElementById('statusNewStories');
            // é•·ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯çŸ­ç¸®ã—ã¦è¡¨ç¤º
            const displayMessage = message.length > 100 ? message.substring(0, 100) + '...' : message;
            statusEl.textContent = displayMessage;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }

        // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œé–¢æ•°
        async function executeCommand(command) {
            console.log(`ğŸš€ [WebUI DEBUG] executeCommand called with: "${command}"`);
            
            const url = document.getElementById('testUrl').value.trim();
            const testGoal = document.getElementById('testGoal').value.trim();
            const pdfFile = document.getElementById('pdfFile').files[0];
            const csvFile = document.getElementById('csvFile').files[0];
            const executionEnvironment = document.getElementById('executionEnvironment').value || 'pc';
            const domAnalysisSource = document.getElementById('domAnalysisSource').value || 'pc';
            
            console.log(`ğŸš€ [WebUI DEBUG] Parameters: url=${url ? 'SET' : 'EMPTY'}, testGoal=${testGoal ? 'SET' : 'EMPTY'}, executionEnv=${executionEnvironment}, domSource=${domAnalysisSource}`);
            
            // ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            document.getElementById('testSummary').style.display = 'none';
            
            // AIä¿®æ­£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’å–å¾—
            const enableAIFix = document.getElementById('enableAIFix').checked;
            
            // æ‰‹å‹•ã‚»ãƒ¬ã‚¯ã‚¿è¨­å®šã‚’å–å¾—
            const manualSelectors = getManualSelectorSettings();
            
            // è‡ªå‹•æ”¹å–„ã‚³ãƒãƒ³ãƒ‰ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            const isAICommand = command === 'analyzeFailures' || command === 'discoverNewStories';
            const isNewStoriesCommand = false; // executeNewStoryCommand ã§å‡¦ç†
            
            // URLå…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!url && command !== 'runScenarios' && command !== 'generateTestReport' && command !== 'analyzeFailures') {
                if (isAICommand) {
                    showStatusAI('ãƒ†ã‚¹ãƒˆå¯¾è±¡URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                } else {
                    showStatus('ãƒ†ã‚¹ãƒˆå¯¾è±¡URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                }
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£IDã‚’è¡¨ç¤º
            if (testGoal && testGoal.trim()) {
                showUserStoryId();
            }
            
            // AIä¿®æ­£è¨­å®šã®è¡¨ç¤º
            if (command === 'analyzeFailures') {
                if (enableAIFix) {
                    addLogAI(`ğŸ¤– AIä¿®æ­£ãƒ¢ãƒ¼ãƒ‰: æœ‰åŠ¹ (ChatGPTã«ã‚ˆã‚‹å¤±æ•—åˆ†æã‚’å®Ÿè¡Œ)`);
                } else {
                    addLogAI(`ğŸ”§ ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰: æœ‰åŠ¹ (ã‚³ã‚¹ãƒˆå‰Šæ¸›ãƒ»å®‰å®šæ€§é‡è¦–)`);
                }
                
                // å¤±æ•—åˆ†ææ™‚ã®ã¿æ‰‹å‹•ã‚»ãƒ¬ã‚¯ã‚¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                showManualSelectorOption();
            }
            
            // ãƒ­ã‚°ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’è‡ªå‹•æ”¹å–„ã‚³ãƒãƒ³ãƒ‰ã«å¿œã˜ã¦åˆ†å²
            if (isAICommand) {
                addLogAI(`ğŸš€ ${getCommandName(command)} ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...`);
                showStatusAI(`${getCommandName(command)} å®Ÿè¡Œä¸­...`, 'info');
            } else {
                addLog(`ğŸš€ ${getCommandName(command)} ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...`);
                showStatus(`${getCommandName(command)} å®Ÿè¡Œä¸­...`, 'info');
            }
            
            try {
                const formData = new FormData();
                formData.append('command', command);
                if (url) formData.append('url', url);
                if (testGoal) formData.append('goal', testGoal);
                if (pdfFile) formData.append('pdf', pdfFile);
                if (csvFile) formData.append('csv', csvFile);
                
                // å®Ÿè¡Œç’°å¢ƒè¨­å®šã‚’é€ä¿¡
                formData.append('executionEnvironment', executionEnvironment);
                formData.append('domAnalysisSource', domAnalysisSource);
                
                // AIä¿®æ­£è¨­å®šã‚’é€ä¿¡ï¼ˆå¤±æ•—åˆ†æã‚³ãƒãƒ³ãƒ‰ã®å ´åˆï¼‰
                if (command === 'analyzeFailures') {
                    formData.append('enableAIFix', enableAIFix ? 'true' : 'false');
                    
                    // æ‰‹å‹•ã‚»ãƒ¬ã‚¯ã‚¿è¨­å®šã‚’é€ä¿¡
                    if (manualSelectors) {
                        formData.append('manualSelectors', JSON.stringify(manualSelectors));
                        addLogAI(`ğŸ¯ è¦ç´ æŒ‡å®šè¨­å®šã‚’é€ä¿¡: ${Object.keys(manualSelectors).length}ã‚«ãƒ†ã‚´ãƒª`);
                    }
                }
                
                console.log(`ğŸš€ [WebUI DEBUG] Sending POST to /api/execute with command: "${command}"`);
                console.log(`ğŸš€ [WebUI DEBUG] FormData keys:`, Array.from(formData.keys()));
                
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    body: formData
                });
                
                console.log(`ğŸš€ [WebUI DEBUG] Response status: ${response.status} ${response.statusText}`);
                
                const result = await response.json();
                
                console.log(`ğŸš€ [WebUI DEBUG] Response result:`, result);
                
                if (result.success) {
                    if (isAICommand) {
                        addLogAI(`âœ… ${getCommandName(command)} ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ`);
                    } else {
                        addLog(`âœ… ${getCommandName(command)} ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ`);
                    }
                    
                    if (result.output) {
                        if (isAICommand) {
                            addLogAI(result.output);
                        } else {
                            addLog(result.output);
                        }
                        
                        // runScenariosã‚³ãƒãƒ³ãƒ‰ã®å ´åˆã€ãƒ†ã‚¹ãƒˆçµæœã‚’è§£æ
                        if (command === 'runScenarios') {
                            console.log('ğŸ› ï¸ [Debug] Full output for parsing:', result.output);
                            parseTestResults(result.output);
                            showStatus(`ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸï¼`, 'success');
                        } else if (command === 'runBatchSequential') {
                            // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®å ´åˆã€ãƒãƒƒãƒçµæœã‚’è§£æ
                            console.log('ğŸ› ï¸ [Debug] Batch execution output:', result.output);
                            parseBatchResults(result.output);
                            showStatus(`ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†ï¼`, 'success');
                        } else if (command === 'generateTestReport') {
                            // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆçµæœã‚’è§£æã—ã¦CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                            console.log('ğŸ› ï¸ [Debug] Processing generateTestReport result...');
                            parseReportGenerationResult(result.output);
                            showStatus(`ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†`, 'success');
                        } else if (command === 'analyzeFailures') {
                            // è‡ªå‹•æ”¹å–„ã‚¿ãƒ–ã§ã‚‚ãƒ†ã‚¹ãƒˆçµæœã‚’è§£æ
                            parseTestResultsAI(result.output);
                            showStatusAI(`å¤±æ•—ãƒ†ã‚¹ãƒˆåˆ†æãƒ»ä¿®æ­£ å®Œäº†`, 'success');
                        } else if (command === 'discoverNewStories') {
                            showStatusAI(`æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç™ºè¦‹ å®Œäº†`, 'success');
                        } else {
                            if (isAICommand) {
                                showStatusAI(`${getCommandName(command)} å®Œäº†`, 'success');
                            } else {
                                showStatus(`${getCommandName(command)} å®Œäº†`, 'success');
                            }
                        }
                    } else {
                        if (isAICommand) {
                            showStatusAI(`${getCommandName(command)} å®Œäº†`, 'success');
                        } else {
                            showStatus(`${getCommandName(command)} å®Œäº†`, 'success');
                        }
                    }
                } else {
                    if (isAICommand) {
                        addLogAI(`âŒ ã‚¨ãƒ©ãƒ¼: ${result.error}`);
                    } else {
                        addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${result.error}`);
                    }
                    
                    if (result.output) {
                        if (isAICommand) {
                            addLogAI(result.output);
                        } else {
                            addLog(result.output);
                        }
                        
                        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚runScenariosã®å ´åˆã¯çµæœã‚’è§£æ
                        if (command === 'runScenarios') {
                            console.log('ğŸ› ï¸ [Debug] Error output for parsing:', result.output);
                            parseTestResults(result.output);
                            showStatus(`ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸï¼ï¼ˆä¸€éƒ¨ã‚¨ãƒ©ãƒ¼ã‚ã‚Šï¼‰`, 'warning');
                        } else if (command === 'analyzeFailures') {
                            // ã‚¨ãƒ©ãƒ¼ã§ã‚‚è‡ªå‹•æ”¹å–„ã‚¿ãƒ–ã§ãƒ†ã‚¹ãƒˆçµæœã‚’è§£æã‚’è©¦è¡Œ
                            parseTestResultsAI(result.output);
                            showStatusAI(`å¤±æ•—ãƒ†ã‚¹ãƒˆåˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${result.error}`, 'error');
                        } else {
                            if (isAICommand) {
                                showStatusAI(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${result.error}`, 'error');
                            } else {
                                showStatus(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${result.error}`, 'error');
                            }
                        }
                    } else {
                        if (isAICommand) {
                            showStatusAI(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${result.error}`, 'error');
                        } else {
                            showStatus(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${result.error}`, 'error');
                        }
                    }
                }
            } catch (error) {
                if (isAICommand) {
                    addLogAI(`âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    showStatusAI(`é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`, 'error');
                } else {
                    addLog(`âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    showStatus(`é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`, 'error');
                }
            }
        }
        
        // ã‚³ãƒãƒ³ãƒ‰åå–å¾—
        function getCommandName(command) {
            const names = {
                'generateTestPoints': 'ãƒ†ã‚¹ãƒˆè¦³ç‚¹ç”Ÿæˆ',
                'generateTestCases': 'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å¤‰æ›',
                'generateSmartScenarios': 'Playwrightç”¨ã«å¤‰æ›',
                'runScenarios': 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ',
                'generateTestReport': 'ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ',
                'analyzeFailures': 'å¤±æ•—ãƒ†ã‚¹ãƒˆåˆ†æãƒ»ä¿®æ­£',
                'discoverNewStories': 'æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç™ºè¦‹'
            };
            return names[command] || command;
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼IDè¡¨ç¤º
        async function showUserStoryId() {
            try {
                const response = await fetch('/api/config/user-story');
                const result = await response.json();
                
                if (result.success && result.userStory && result.userStory.currentId) {
                    document.getElementById('currentUserStoryId').textContent = `US-${result.userStory.currentId}`;
                    document.getElementById('userStoryId').style.display = 'block';
                    console.log(`ğŸ”— ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ID US-${result.userStory.currentId} ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
                } else {
                    // IDãŒæœªæ¡ç•ªã®å ´åˆã¯éè¡¨ç¤º
                    document.getElementById('userStoryId').style.display = 'none';
                }
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼IDå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('userStoryId').style.display = 'none';
            }
        }

        // ãƒ†ã‚¹ãƒˆå±¥æ­´ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆç´¯ç©ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒªã‚»ãƒƒãƒˆï¼‰
        async function resetTestHistory() {
            if (!confirm('éå»ã®ãƒ†ã‚¹ãƒˆæƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nâœ¨ ä»¥ä¸‹ã®æƒ…å ±ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼š\n' +
                       'â€¢ ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ID (æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚µã‚¤ã‚¯ãƒ«é–‹å§‹)\n' +
                       'â€¢ ç´¯ç©ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±\n' +
                       'â€¢ éå»ã®ãƒ†ã‚¹ãƒˆçµæœå±¥æ­´\n\n' +
                       'æ¬¡å›ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚µã‚¤ã‚¯ãƒ«ã¨ã—ã¦é–‹å§‹ã•ã‚Œã¾ã™ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch('/api/reset-test-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // UIã‚’æ›´æ–°
                    document.getElementById('currentUserStoryId').textContent = '-';
                    document.getElementById('userStoryId').style.display = 'none';
                    
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    alert(`âœ… ãƒ†ã‚¹ãƒˆå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚\n\nğŸ“Š å‰Šé™¤ã•ã‚ŒãŸé …ç›®ï¼š\n` +
                          `â€¢ ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«: ${result.deletedResults || 0}ä»¶\n` +
                          `â€¢ ã‚·ãƒŠãƒªã‚ªãƒ•ã‚¡ã‚¤ãƒ«: ${result.deletedRoutes || 0}ä»¶\n` +
                          `â€¢ ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: ${result.deletedReports || 0}ä»¶\n\n` +
                          'æ¬¡å›ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«æ–°ã—ã„ãƒ†ã‚¹ãƒˆã‚µã‚¤ã‚¯ãƒ«ã¨ã—ã¦é–‹å§‹ã•ã‚Œã¾ã™ã€‚');
                    console.log('ğŸ”„ ãƒ†ã‚¹ãƒˆå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ:', result);
                } else {
                    alert(`âŒ ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error}`);
                    console.error('ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', result.error);
                }
            } catch (error) {
                alert(`âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                console.error('ãƒ†ã‚¹ãƒˆå±¥æ­´ãƒªã‚»ãƒƒãƒˆé€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ä¸€æ‹¬å®Ÿè¡Œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
        async function executeBulkWorkflow() {
            const url = document.getElementById('testUrl').value;
            const testGoal = document.getElementById('testGoal').value;
            
            // åŸºæœ¬çš„ãªå…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!url || !url.trim()) {
                alert('âš ï¸ ãƒ†ã‚¹ãƒˆå¯¾è±¡URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!testGoal || !testGoal.trim()) {
                alert('âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            if (!confirm('ğŸš€ ä»¥ä¸‹ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ï¼š\n\n' +
                '1. ğŸ“‹ ãƒ†ã‚¹ãƒˆè¦³ç‚¹ç”Ÿæˆ\n' +
                '2. ğŸ­ Playwrightç”¨ã«å¤‰æ›\n' +
                '3. â–¶ï¸ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ\n' +
                '4. ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ\n' +
                '5. ğŸ”§ å¤±æ•—åˆ†æï¼ˆå¤±æ•—ãŒã‚ã‚‹å ´åˆï¼‰\n' +
                '6. ğŸš€ å†ãƒˆãƒ©ã‚¤ï¼ˆä¿®æ­£ã‚·ãƒŠãƒªã‚ªãŒã‚ã‚‹å ´åˆï¼‰\n' +
                '7. ğŸ” æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç™ºè¦‹\n\n' +
                'å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿï¼ˆå‡¦ç†ã«æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰')) {
                return;
            }
            
            // ä¸€æ‹¬å®Ÿè¡ŒUIè¡¨ç¤º
            showBulkStatus();
            
            // å„ã‚¿ãƒ–ã®ãƒ­ã‚°ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
            clearAllLogs();
            
            try {
                let hasFailures = false;
                let fixedRouteId = null;
                
                // 1. ãƒ†ã‚¹ãƒˆè¦³ç‚¹ç”Ÿæˆ
                updateBulkProgress('step-testpoints', 'active', 'ğŸ“‹ ãƒ†ã‚¹ãƒˆè¦³ç‚¹ã‚’ç”Ÿæˆä¸­...');
                await executeCommand('generateTestPoints');
                await delay(1000);
                updateBulkProgress('step-testpoints', 'completed', 'âœ… ãƒ†ã‚¹ãƒˆè¦³ç‚¹ç”Ÿæˆå®Œäº†');
                
                // 2. ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç”Ÿæˆ
                updateBulkProgress('step-testcases', 'active', 'ğŸ§  ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç”Ÿæˆä¸­...');
                await executeCommand('generateTestCases');
                await delay(1000);
                updateBulkProgress('step-testcases', 'completed', 'âœ… ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç”Ÿæˆå®Œäº†');
                
                // 3. Playwrightç”¨ã«å¤‰æ›
                updateBulkProgress('step-routes', 'active', 'ğŸ­ Playwrightç”¨ã«å¤‰æ›ä¸­...');
                await executeCommand('generateSmartScenariosAll');
                await delay(1000);
                updateBulkProgress('step-routes', 'completed', 'âœ… Playwrightç”¨ã«å¤‰æ›å®Œäº†');
                
                // 4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                updateBulkProgress('step-run', 'active', 'â–¶ï¸ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
                await executeCommand('runBatchSequential');
                await delay(1000);
                updateBulkProgress('step-run', 'completed', 'âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†');
                
                // å¤±æ•—æ•°ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒãƒƒãƒçµæœã‹ã‚‰ï¼‰
                const batchResults = await checkBatchResults();
                if (batchResults && batchResults.hasFailures) {
                    hasFailures = true;
                }
                
                // 5. ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
                updateBulkProgress('step-report', 'active', 'ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...');
                const reportResult = await executeCommandWithResult('generateTestReport');
                await delay(1000);
                updateBulkProgress('step-report', 'completed', 'âœ… ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†');
                
                // HTMLãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Œã°ä¿å­˜
                let htmlReportUrl = null;
                if (reportResult && reportResult.htmlReportUrl) {
                    htmlReportUrl = reportResult.htmlReportUrl;
                }
                
                // 6. å¤±æ•—åˆ†æï¼ˆå¤±æ•—ãŒã‚ã‚‹å ´åˆï¼‰
                if (hasFailures) {
                    updateBulkProgress('step-analyze', 'active', 'ğŸ”§ å¤±æ•—ãƒ†ã‚¹ãƒˆã‚’åˆ†æä¸­...');
                    
                    // AIä¿®æ­£è¨­å®šã‚’åæ˜ ã—ã¦å¤±æ•—åˆ†æã‚’å®Ÿè¡Œ
                    const enableAIFix = document.getElementById('enableAIFix').checked;
                    if (enableAIFix) {
                        addLog('ğŸ¤– AIä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã§å¤±æ•—åˆ†æã‚’å®Ÿè¡Œä¸­...');
                    } else {
                        addLog('ğŸ”§ ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã§å¤±æ•—åˆ†æã‚’å®Ÿè¡Œä¸­...');
                    }
                    
                    await executeCommand('analyzeFailures');
                    await delay(2000); // åˆ†æã¯æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚å°‘ã—é•·ã‚ã«å¾…æ©Ÿ
                    
                    // ä¿®æ­£ã‚·ãƒŠãƒªã‚ªãŒç”Ÿæˆã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
                    const response = await fetch('/api/check-fixed-routes');
                    const result = await response.json();
                    if (result.success && result.hasFixedRoutes) {
                        fixedRouteId = result.latestFixedRoute;
                        updateBulkProgress('step-analyze', 'completed', 'âœ… å¤±æ•—åˆ†æå®Œäº†ï¼ˆä¿®æ­£ã‚·ãƒŠãƒªã‚ªç”Ÿæˆæ¸ˆã¿ï¼‰');
                    } else {
                        updateBulkProgress('step-analyze', 'completed', 'âœ… å¤±æ•—åˆ†æå®Œäº†');
                    }
                } else {
                    updateBulkProgress('step-analyze', 'completed', 'â­ï¸ å¤±æ•—ãªã—ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
                }
                
                // 7. å†ãƒˆãƒ©ã‚¤ï¼ˆä¿®æ­£ã‚·ãƒŠãƒªã‚ªãŒã‚ã‚‹å ´åˆï¼‰
                if (fixedRouteId) {
                    updateBulkProgress('step-retry', 'active', 'ğŸš€ ä¿®æ­£ã‚·ãƒŠãƒªã‚ªã§å†ãƒˆãƒ©ã‚¤ä¸­...');
                    await runFixedRoute(fixedRouteId);
                    await delay(1000);
                    updateBulkProgress('step-retry', 'completed', 'âœ… å†ãƒˆãƒ©ã‚¤å®Œäº†');
                } else {
                    updateBulkProgress('step-retry', 'completed', 'â­ï¸ ä¿®æ­£ã‚·ãƒŠãƒªã‚ªãªã—ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
                }
                
                // 8. æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç™ºè¦‹
                updateBulkProgress('step-stories', 'active', 'ğŸ” æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç™ºè¦‹ä¸­...');
                await executeCommand('discoverNewStories');
                await delay(1000);
                updateBulkProgress('step-stories', 'completed', 'âœ… æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç™ºè¦‹å®Œäº†');
                
                // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                updateBulkCurrentAction('ğŸ‰ ã™ã¹ã¦ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                
                setTimeout(() => {
                    // HTMLãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Œã°è‡ªå‹•ã§é–‹ã
                    if (htmlReportUrl) {
                        if (confirm('ğŸ‰ ä¸€æ‹¬å®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nHTMLãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ã§é–‹ãã¾ã™ã‹ï¼Ÿ\n\n' +
                                    'å„ã‚¿ãƒ–ã§è©³ç´°ãªçµæœã‚‚ç¢ºèªã§ãã¾ã™ï¼š\n' +
                                    'â€¢ ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: å®Ÿè¡Œçµæœã¨ã‚µãƒãƒªãƒ¼\n' +
                                    'â€¢ ğŸ¤– è‡ªå‹•æ”¹å–„ãƒ»å­¦ç¿’æ©Ÿèƒ½: å¤±æ•—åˆ†æã¨ä¿®æ­£çµæœ\n' +
                                    'â€¢ ğŸ“– æ–°ã—ã„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼: ç™ºè¦‹ã•ã‚ŒãŸæ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼')) {
                            window.open(htmlReportUrl, '_blank');
                        }
                    } else {
                        alert('ğŸ‰ ä¸€æ‹¬å®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\n' +
                            'å„ã‚¿ãƒ–ã§è©³ç´°ãªçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š\n' +
                            'â€¢ ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: å®Ÿè¡Œçµæœã¨ã‚µãƒãƒªãƒ¼\n' +
                            'â€¢ ğŸ¤– è‡ªå‹•æ”¹å–„ãƒ»å­¦ç¿’æ©Ÿèƒ½: å¤±æ•—åˆ†æã¨ä¿®æ­£çµæœ\n' +
                            'â€¢ ğŸ“– æ–°ã—ã„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼: ç™ºè¦‹ã•ã‚ŒãŸæ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('ä¸€æ‹¬å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
                updateBulkCurrentAction(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                alert(`âŒ ä¸€æ‹¬å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${error.message}\n\nå„ã‚¿ãƒ–ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            }
        }
        
        // çµæœã‚’è¿”ã™ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œé–¢æ•°ï¼ˆä¸€æ‹¬å®Ÿè¡Œç”¨ï¼‰
        async function executeCommandWithResult(command) {
            const url = document.getElementById('testUrl').value;
            const testGoal = document.getElementById('testGoal').value;
            const pdfFile = document.getElementById('pdfFile').files[0];
            const csvFile = document.getElementById('csvFile').files[0];
            
            try {
                const formData = new FormData();
                formData.append('command', command);
                if (url) formData.append('url', url);
                if (testGoal) formData.append('goal', testGoal);
                if (pdfFile) formData.append('pdf', pdfFile);
                if (csvFile) formData.append('csv', csvFile);
                
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // ãƒ­ã‚°ã«çµæœã‚’å‡ºåŠ›ï¼ˆé€šå¸¸ã®executeCommandã¨åŒã˜å‡¦ç†ï¼‰
                if (result.success) {
                    addLog(`âœ… ${getCommandName(command)} ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ`);
                    if (result.output) {
                        addLog(result.output);
                    }
                } else {
                    addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${result.error}`);
                    if (result.output) {
                        addLog(result.output);
                    }
                }
                
                return result;
            } catch (error) {
                addLog(`âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                return null;
            }
        }

        // ä¸€æ‹¬å®Ÿè¡Œç”¨ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function showBulkStatus() {
            document.getElementById('bulkStatus').style.display = 'block';
            // ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
            const steps = ['step-testpoints', 'step-testcases', 'step-routes', 'step-run', 'step-report', 'step-analyze', 'step-retry', 'step-stories'];
            steps.forEach(stepId => {
                const element = document.getElementById(stepId);
                element.className = 'progress-step';
            });
            updateBulkCurrentAction('ğŸš€ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã—ã¾ã™...');
        }
        
        function updateBulkProgress(stepId, status, message) {
            const element = document.getElementById(stepId);
            element.className = `progress-step ${status}`;
            updateBulkCurrentAction(message);
        }
        
        function updateBulkCurrentAction(message) {
            document.getElementById('bulkCurrentAction').textContent = message;
        }
        
        function clearAllLogs() {
            // å„ã‚¿ãƒ–ã®ãƒ­ã‚°ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('logArea').textContent = 'å®Ÿè¡Œãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...';
            document.getElementById('logAreaAI').textContent = 'å®Ÿè¡Œãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...';
            document.getElementById('logAreaNewStories').textContent = 'å®Ÿè¡Œãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...';
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”¨ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œé–¢æ•°
        async function executeNewStoryCommand(command) {
            let url = document.getElementById('testUrl').value;
            const testGoal = document.getElementById('testGoal').value;
            const pdfFile = document.getElementById('pdfFile').files[0];
            const csvFile = document.getElementById('csvFile').files[0];
            
            // URLãŒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®å ´åˆã€config.jsonã®è¨­å®šå€¤ã‚’ä½¿ç”¨
            if (!url || url.includes('[ãƒ†ã‚¹ãƒˆå¯¾è±¡URL]') || url.includes('[') || url.trim() === '') {
                try {
                    const configResponse = await fetch('/api/config');
                    const config = await configResponse.json();
                    if (config.targetUrl) {
                        url = config.targetUrl;
                        document.getElementById('testUrl').value = url;
                        addLogNewStories(`ğŸ”§ URLã‚’config.jsonã®è¨­å®šå€¤ã«ç½®ãæ›ãˆã¾ã—ãŸ: ${url}`);
                    }
                } catch (error) {
                    console.error('Configèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            // URLå…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!url && command !== 'runScenarios' && command !== 'generateTestReport') {
                showStatusNewStories('ãƒ†ã‚¹ãƒˆå¯¾è±¡URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é¸æŠãƒã‚§ãƒƒã‚¯ï¼ˆgenerateSmartScenariosã¯é™¤å¤–ï¼‰
            if ((!testGoal || !testGoal.trim()) && command !== 'generateSmartScenarios' && command !== 'generateTestCases') {
                showStatusNewStories('ç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£IDã‚’è¡¨ç¤º
            if (testGoal && testGoal.trim()) {
                showUserStoryId();
            }
            
            addLogNewStories(`ğŸš€ ${getCommandName(command)} ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...`);
            showStatusNewStories(`${getCommandName(command)} å®Ÿè¡Œä¸­...`, 'info');
            
            try {
                const formData = new FormData();
                formData.append('command', command);
                if (url) formData.append('url', url);
                if (testGoal) formData.append('goal', testGoal);
                if (pdfFile) formData.append('pdf', pdfFile);
                if (csvFile) formData.append('csv', csvFile);
                
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLogNewStories(`âœ… ${getCommandName(command)} ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ`);
                    
                    if (result.output) {
                        addLogNewStories(result.output);
                        
                        // runScenariosã‚³ãƒãƒ³ãƒ‰ã®å ´åˆã€ãƒ†ã‚¹ãƒˆçµæœã‚’è§£æ
                        if (command === 'runScenarios') {
                            console.log('ğŸ› ï¸ [Debug] Full output for parsing (New Stories):', result.output);
                            parseTestResultsNewStories(result.output);
                            showStatusNewStories(`æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸï¼`, 'success');
                        } else {
                            showStatusNewStories(`${getCommandName(command)} å®Œäº†`, 'success');
                        }
                    } else {
                        showStatusNewStories(`${getCommandName(command)} å®Œäº†`, 'success');
                    }
                } else {
                    addLogNewStories(`âŒ ã‚¨ãƒ©ãƒ¼: ${result.error}`);
                    
                    if (result.output) {
                        addLogNewStories(result.output);
                        
                        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚runScenariosã®å ´åˆã¯çµæœã‚’è§£æ
                        if (command === 'runScenarios') {
                            console.log('ğŸ› ï¸ [Debug] Error output for parsing (New Stories):', result.output);
                            parseTestResultsNewStories(result.output);
                            showStatusNewStories(`æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã—ãŸï¼ï¼ˆä¸€éƒ¨ã‚¨ãƒ©ãƒ¼ã‚ã‚Šï¼‰`, 'warning');
                        } else {
                            showStatusNewStories(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${result.error}`, 'error');
                        }
                    } else {
                        showStatusNewStories(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${result.error}`, 'error');
                    }
                }
            } catch (error) {
                addLogNewStories(`âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showStatusNewStories(`é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`, 'error');
            }
        }

        // ãƒ†ã‚¹ãƒˆçµæœè§£æé–¢æ•°
        function parseTestResults(output) {
            try {
                console.log('ğŸ› ï¸ [Debug] Parsing test results...');
                const lines = output.split('\n');
                let testId = '-';
                let totalSteps = '-';
                let successCount = '-';
                let failureCount = '-';
                const failedTests = [];
                let resultFilePath = '';
                
                let inFailedSection = false;
                
                console.log('ğŸ› ï¸ [Debug] Total lines to parse:', lines.length);
                
                for (const line of lines) {
                    // ãƒ†ã‚¹ãƒˆIDã®æŠ½å‡º
                    const testIdMatch = line.match(/ğŸ”· ãƒ†ã‚¹ãƒˆID:\s*(.+)/);
                    if (testIdMatch) {
                        testId = testIdMatch[1].trim();
                    }
                    
                    // ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°ã®æŠ½å‡º
                    const totalStepsMatch = line.match(/ğŸ”· ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°:\s*(\d+)/);
                    if (totalStepsMatch) {
                        totalSteps = totalStepsMatch[1];
                    }
                    
                    // æˆåŠŸæ•°ã®æŠ½å‡º
                    const successMatch = line.match(/ğŸ”· æˆåŠŸæ•°:\s*(\d+)/);
                    if (successMatch) {
                        successCount = successMatch[1];
                    }
                    
                    // å¤±æ•—æ•°ã®æŠ½å‡º
                    const failureMatch = line.match(/ğŸ”· å¤±æ•—æ•°:\s*(\d+)/);
                    if (failureMatch) {
                        failureCount = failureMatch[1];
                    }
                    
                    // çµæœãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®æŠ½å‡º
                    const resultFileMatch = line.match(/ğŸ“ ãƒ†ã‚¹ãƒˆçµæœã‚’ä¿å­˜ã—ã¾ã—ãŸ:\s*(.+\.json)/);
                    if (resultFileMatch) {
                        resultFilePath = resultFileMatch[1].trim();
                    }
                    
                    // å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
                    if (line.includes('âŒ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹:')) {
                        inFailedSection = true;
                        continue;
                    }
                    
                    // å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æŠ½å‡ºï¼ˆã‚ˆã‚Šæ­£ç¢ºãªè§£æï¼‰
                    if (inFailedSection) {
                        // "  - " ã§å§‹ã¾ã‚‹è¡Œã‚’æŠ½å‡º
                        const failedTestMatch = line.match(/^\s*-\s*(.+)/);
                        if (failedTestMatch) {
                            const failedTest = cleanErrorMessage(failedTestMatch[1].trim());
                            if (failedTest.trim()) {
                                failedTests.push(failedTest);
                            }
                        }
                        
                        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†åˆ¤å®šï¼ˆç©ºè¡Œã¾ãŸã¯æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ï¼‰
                        if (line.trim() === '' || line.includes('ğŸ“ ãƒ†ã‚¹ãƒˆçµæœã‚’ä¿å­˜ã—ã¾ã—ãŸ')) {
                            inFailedSection = false;
                        }
                    }
                }
                
                // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
                console.log('ğŸ› ï¸ [Debug] Extracted data:', {testId, totalSteps, successCount, failureCount, failedTestsCount: failedTests.length, resultFilePath});
                displayTestSummary(testId, totalSteps, successCount, failureCount, failedTests, resultFilePath);
                
            } catch (error) {
                console.error('ãƒ†ã‚¹ãƒˆçµæœè§£æã‚¨ãƒ©ãƒ¼:', error);
                addLog(`âš ï¸ ãƒ†ã‚¹ãƒˆçµæœã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ•´ç†ã™ã‚‹é–¢æ•°
        function cleanErrorMessage(message) {
            return message
                .replace(/STDOUT:\s*/g, '')
                .replace(/STDERR:\s*/g, '')
                .replace(/^\s*[\[\]]+\s*/, '')
                .replace(/\s*[\[\]]+\s*$/, '')
                .trim();
        }

        // ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼è¡¨ç¤ºé–¢æ•°
        function displayTestSummary(testId, totalSteps, successCount, failureCount, failedTests, resultFilePath) {
            // å€¤ã‚’è¨­å®š
            document.getElementById('testId').textContent = testId;
            document.getElementById('totalSteps').textContent = totalSteps;
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('failureCount').textContent = failureCount;
            
            // å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®è¡¨ç¤º
            const failedTestsSection = document.getElementById('failedTests');
            const failedTestsList = document.getElementById('failedTestsList');
            
            if (failedTests.length > 0) {
                failedTestsList.innerHTML = '';
                failedTests.forEach(test => {
                    const li = document.createElement('li');
                    li.textContent = test;
                    failedTestsList.appendChild(li);
                });
                failedTestsSection.style.display = 'block';
            } else {
                failedTestsSection.style.display = 'none';
            }
            
            // æ—¢å­˜ã®çµæœãƒ•ã‚¡ã‚¤ãƒ«ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤
            const existingLink = document.getElementById('resultFileLink');
            if (existingLink) {
                existingLink.remove();
            }
            
            // çµæœãƒ•ã‚¡ã‚¤ãƒ«ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
            if (resultFilePath) {
                const filename = resultFilePath.split('/').pop();
                const resultFileContainer = document.createElement('div');
                resultFileContainer.id = 'resultFileLink';
                resultFileContainer.style.marginTop = '15px';
                resultFileContainer.style.padding = '15px';
                resultFileContainer.style.background = 'linear-gradient(135deg, #f8f9fa, #e9ecef)';
                resultFileContainer.style.border = '2px solid #007bff';
                resultFileContainer.style.borderRadius = '10px';
                resultFileContainer.style.textAlign = 'center';
                
                const linkTitle = document.createElement('h4');
                linkTitle.textContent = 'ğŸ“„ ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«';
                linkTitle.style.margin = '0 0 10px 0';
                linkTitle.style.color = '#0056b3';
                linkTitle.style.fontSize = '1rem';
                
                const resultFileLink = document.createElement('a');
                resultFileLink.href = `/api/results/${filename}`;
                resultFileLink.textContent = `ğŸ“ ${filename}`;
                resultFileLink.style.display = 'inline-block';
                resultFileLink.style.marginTop = '5px';
                resultFileLink.style.textDecoration = 'none';
                resultFileLink.style.color = 'white';
                resultFileLink.style.padding = '10px 20px';
                resultFileLink.style.background = 'linear-gradient(135deg, #007bff, #0056b3)';
                resultFileLink.style.borderRadius = '8px';
                resultFileLink.style.transition = 'all 0.3s ease';
                resultFileLink.style.fontWeight = '600';
                
                resultFileLink.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.boxShadow = '0 4px 12px rgba(0, 123, 255, 0.3)';
                });
                
                resultFileLink.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = 'none';
                });
                
                resultFileContainer.appendChild(linkTitle);
                resultFileContainer.appendChild(resultFileLink);
                document.getElementById('testSummary').appendChild(resultFileContainer);
                
                addLog(`ğŸ“ çµæœãƒ•ã‚¡ã‚¤ãƒ«: ${filename} ã¸ã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
            }
            
            // ã‚µãƒãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('testSummary').style.display = 'block';
            
            addLog(`ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ`);
        }
        
        // è‡ªå‹•æ”¹å–„ã‚¿ãƒ–ç”¨ã®ãƒ†ã‚¹ãƒˆçµæœè§£æé–¢æ•°
        function parseTestResultsAI(output) {
            try {
                console.log('ğŸ› ï¸ [Debug] Parsing AI test results...');
                const lines = output.split('\n');
                let testId = '-';
                let totalSteps = '-';
                let successCount = '-';
                let failureCount = '-';
                const failedTests = [];
                let resultFilePath = '';
                
                let inFailedSection = false;
                
                for (const line of lines) {
                    // ãƒ†ã‚¹ãƒˆIDã®æŠ½å‡º
                    const testIdMatch = line.match(/ğŸ”· ãƒ†ã‚¹ãƒˆID:\s*(.+)/);
                    if (testIdMatch) {
                        testId = testIdMatch[1].trim();
                    }
                    
                    // ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°ã®æŠ½å‡º
                    const totalStepsMatch = line.match(/ğŸ”· ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°:\s*(\d+)/);
                    if (totalStepsMatch) {
                        totalSteps = totalStepsMatch[1];
                    }
                    
                    // æˆåŠŸæ•°ã®æŠ½å‡º
                    const successMatch = line.match(/ğŸ”· æˆåŠŸæ•°:\s*(\d+)/);
                    if (successMatch) {
                        successCount = successMatch[1];
                    }
                    
                    // å¤±æ•—æ•°ã®æŠ½å‡º
                    const failureMatch = line.match(/ğŸ”· å¤±æ•—æ•°:\s*(\d+)/);
                    if (failureMatch) {
                        failureCount = failureMatch[1];
                    }
                    
                    // çµæœãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®æŠ½å‡º
                    const resultFileMatch = line.match(/ğŸ“ ãƒ†ã‚¹ãƒˆçµæœã‚’ä¿å­˜ã—ã¾ã—ãŸ:\s*(.+\.json)/);
                    if (resultFileMatch) {
                        resultFilePath = resultFileMatch[1].trim();
                    }
                    
                    // å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
                    if (line.includes('âŒ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹:')) {
                        inFailedSection = true;
                        continue;
                    }
                    
                    // å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æŠ½å‡º
                    if (inFailedSection) {
                        const failedTestMatch = line.match(/^\s*-\s*(.+)/);
                        if (failedTestMatch) {
                            const failedTest = cleanErrorMessage(failedTestMatch[1].trim());
                            if (failedTest.trim()) {
                                failedTests.push(failedTest);
                            }
                        }
                        
                        if (line.trim() === '' || line.includes('ğŸ“ ãƒ†ã‚¹ãƒˆçµæœã‚’ä¿å­˜ã—ã¾ã—ãŸ')) {
                            inFailedSection = false;
                        }
                    }
                }
                
                // è‡ªå‹•æ”¹å–„ã‚¿ãƒ–ã®ã‚µãƒãƒªãƒ¼è¡¨ç¤º
                displayTestSummaryAI(testId, totalSteps, successCount, failureCount, failedTests, resultFilePath);
                
            } catch (error) {
                console.error('è‡ªå‹•æ”¹å–„ãƒ†ã‚¹ãƒˆçµæœè§£æã‚¨ãƒ©ãƒ¼:', error);
                addLogAI(`âš ï¸ ãƒ†ã‚¹ãƒˆçµæœã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }
        
        // è‡ªå‹•æ”¹å–„ã‚¿ãƒ–ç”¨ã®ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼è¡¨ç¤ºé–¢æ•°
        function displayTestSummaryAI(testId, totalSteps, successCount, failureCount, failedTests, resultFilePath) {
            // å€¤ã‚’è¨­å®š
            document.getElementById('testIdAI').textContent = testId;
            document.getElementById('totalStepsAI').textContent = totalSteps;
            document.getElementById('successCountAI').textContent = successCount;
            document.getElementById('failureCountAI').textContent = failureCount;
            
            // å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®è¡¨ç¤º
            const failedTestsSection = document.getElementById('failedTestsAI');
            const failedTestsList = document.getElementById('failedTestsListAI');
            
            if (failedTests.length > 0) {
                failedTestsList.innerHTML = '';
                failedTests.forEach(test => {
                    const li = document.createElement('li');
                    li.textContent = test;
                    failedTestsList.appendChild(li);
                });
                failedTestsSection.style.display = 'block';
            } else {
                failedTestsSection.style.display = 'none';
            }
            
            // ã‚µãƒãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('testSummaryAI').style.display = 'block';
            
            addLogAI(`ğŸ“Š è‡ªå‹•æ”¹å–„ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ`);
        }
        
        // æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¿ãƒ–ç”¨ã®ãƒ†ã‚¹ãƒˆçµæœè§£æé–¢æ•°
        function parseTestResultsNewStories(output) {
            try {
                console.log('ğŸ› ï¸ [Debug] Parsing New Stories test results...');
                const lines = output.split('\n');
                let testId = '-';
                let totalSteps = '-';
                let successCount = '-';
                let failureCount = '-';
                const failedTests = [];
                let resultFilePath = '';
                
                let inFailedSection = false;
                
                for (const line of lines) {
                    // ãƒ†ã‚¹ãƒˆIDã®æŠ½å‡º
                    const testIdMatch = line.match(/ğŸ”· ãƒ†ã‚¹ãƒˆID:\s*(.+)/);
                    if (testIdMatch) {
                        testId = testIdMatch[1].trim();
                    }
                    
                    // ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°ã®æŠ½å‡º
                    const totalStepsMatch = line.match(/ğŸ”· ç·ã‚¹ãƒ†ãƒƒãƒ—æ•°:\s*(\d+)/);
                    if (totalStepsMatch) {
                        totalSteps = totalStepsMatch[1];
                    }
                    
                    // æˆåŠŸæ•°ã®æŠ½å‡º
                    const successMatch = line.match(/ğŸ”· æˆåŠŸæ•°:\s*(\d+)/);
                    if (successMatch) {
                        successCount = successMatch[1];
                    }
                    
                    // å¤±æ•—æ•°ã®æŠ½å‡º
                    const failureMatch = line.match(/ğŸ”· å¤±æ•—æ•°:\s*(\d+)/);
                    if (failureMatch) {
                        failureCount = failureMatch[1];
                    }
                    
                    // å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®é–‹å§‹
                    if (line.includes('âŒ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹:')) {
                        inFailedSection = true;
                        continue;
                    }
                    
                    // å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æŠ½å‡º
                    if (inFailedSection && line.includes('- ')) {
                        const failedTest = line.replace('STDOUT:', '').replace(/^\s*[-]\s*/, '').trim();
                        if (failedTest) {
                            failedTests.push(failedTest);
                        }
                    }
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®æŠ½å‡º
                    const filePathMatch = line.match(/ğŸ“ ãƒ†ã‚¹ãƒˆçµæœã‚’ä¿å­˜ã—ã¾ã—ãŸ:\s*(.+)/);
                    if (filePathMatch) {
                        resultFilePath = filePathMatch[1].trim();
                        inFailedSection = false; // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜æ™‚ç‚¹ã§å¤±æ•—ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†
                    }
                }
                
                // çµæœã‚’è¡¨ç¤º
                displayTestSummaryNewStories(testId, totalSteps, successCount, failureCount, failedTests);
                
                if (resultFilePath) {
                    addLogNewStories(`ğŸ“ ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«: ${resultFilePath}`);
                }
                
                console.log('ğŸ› ï¸ [Debug] Parsed New Stories results:', {
                    testId, totalSteps, successCount, failureCount, failedTests
                });
            } catch (error) {
                console.error('ğŸ› ï¸ [Debug] Error parsing New Stories test results:', error);
                addLogNewStories(`âŒ ãƒ†ã‚¹ãƒˆçµæœã®è§£æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        }
        
        // æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¿ãƒ–ç”¨ã®ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼è¡¨ç¤ºé–¢æ•°
        function displayTestSummaryNewStories(testId, totalSteps, successCount, failureCount, failedTests) {
            document.getElementById('testIdNewStories').textContent = testId;
            document.getElementById('totalStepsNewStories').textContent = totalSteps;
            document.getElementById('successCountNewStories').textContent = successCount;
            document.getElementById('failureCountNewStories').textContent = failureCount;
            
            // å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¡¨ç¤º
            const failedTestsList = document.getElementById('failedTestsListNewStories');
            const failedTestsContainer = document.getElementById('failedTestsNewStories');
            
            if (failedTests.length > 0) {
                failedTestsList.innerHTML = '';
                failedTests.forEach(test => {
                    const li = document.createElement('li');
                    li.textContent = test;
                    failedTestsList.appendChild(li);
                });
                failedTestsContainer.style.display = 'block';
            } else {
                failedTestsContainer.style.display = 'none';
            }
            
            // ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
            document.getElementById('testSummaryNewStories').style.display = 'block';
            addLogNewStories(`ğŸ“Š æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ`);
        }

        // AIè¨­å®šé–¢æ•°
        function updateTemperatureDisplay() {
            const temperature = document.getElementById('aiTemperature').value;
            document.getElementById('temperatureValue').textContent = temperature;
        }
        
        function updateTopPDisplay() {
            const topP = document.getElementById('aiTopP').value;
            document.getElementById('topPValue').textContent = topP;
        }
        
        function loadAIConfig(config) {
            if (config.openai) {
                document.getElementById('aiModel').value = config.openai.model || 'gpt-4o-mini';
                document.getElementById('aiTemperature').value = config.openai.temperature || 0.5;
                document.getElementById('aiMaxTokens').value = config.openai.max_tokens || 4000;
                document.getElementById('aiTopP').value = config.openai.top_p || 0.9;
                updateTemperatureDisplay();
                updateTopPDisplay();
            }
        }
        
        async function saveAIConfig() {
            const aiConfig = {
                model: document.getElementById('aiModel').value,
                temperature: parseFloat(document.getElementById('aiTemperature').value),
                max_tokens: parseInt(document.getElementById('aiMaxTokens').value),
                top_p: parseFloat(document.getElementById('aiTopP').value)
            };
            
            try {
                const response = await fetch('/api/config/ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(aiConfig)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('ğŸ’¾ AIè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                    showStatus('AIè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                } else {
                    addLog(`âŒ AIè¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ${result.error}`);
                    showStatus('AIè¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                addLog(`âŒ AIè¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showStatus('AIè¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        function resetAIConfig() {
            document.getElementById('aiModel').value = 'gpt-4o-mini';
            document.getElementById('aiTemperature').value = 0.5;
            document.getElementById('aiMaxTokens').value = 4000;
            document.getElementById('aiTopP').value = 0.9;
            updateTemperatureDisplay();
            updateTopPDisplay();
            addLog('ğŸ”„ AIè¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ');
            showStatus('AIè¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ', 'info');
        }



        // æ‰‹å‹•ã‚¬ã‚¤ãƒ‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
        function showManualGuide() {
            document.getElementById('manualGuideModal').style.display = 'block';
            addLog('ğŸ“‹ æ‰‹å‹•ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªä½œæˆã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        function closeModal(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('manualGuideModal').style.display = 'none';
                document.getElementById('fixedRouteModal').style.display = 'none';
                document.getElementById('discoveredStoriesModal').style.display = 'none';
                addLog('ğŸ“‹ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã¾ã—ãŸ');
            }
        }

        // ç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
        async function showDiscoveredStoriesModal() {
            document.getElementById('discoveredStoriesModal').style.display = 'block';
            addLogNewStories('ğŸ“– ç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é¸æŠç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
            
            // ç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
            await loadDiscoveredStories();
        }

        // ç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadDiscoveredStories() {
            try {
                const response = await fetch('/api/list-files?pattern=discovered_stories_*.json');
                const result = await response.json();
                
                const storiesListEl = document.getElementById('discoveredStoriesList');
                
                if (result.success && result.files && result.files.length > 0) {
                    let html = '<div class="file-list">';
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                    const sortedFiles = result.files.sort((a, b) => b.localeCompare(a));
                    
                    for (const file of sortedFiles) {
                        // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ—¥æ™‚ã‚’æŠ½å‡º
                        const dateMatch = file.match(/discovered_stories_(.+)\.json$/);
                        const dateStr = dateMatch ? dateMatch[1].replace(/T/g, ' ').replace(/-/g, '/').replace('Z', '') : 'Unknown';
                        
                        html += `
                            <div class="file-item">
                                <div class="file-info">
                                    <div class="file-name">ğŸ“ ${file}</div>
                                    <div class="file-date">ğŸ“… ä½œæˆæ—¥æ™‚: ${dateStr}</div>
                                </div>
                                <button class="btn btn-small btn-info" onclick="loadDiscoveredStoriesFromFile('${file}')">
                                    ğŸ“‹ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ä¸€è¦§è¡¨ç¤º
                                </button>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    storiesListEl.innerHTML = html;
                } else {
                    storiesListEl.innerHTML = '<p>âŒ ç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br>ã¾ãšã€Œæ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç™ºè¦‹ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>';
                }
            } catch (error) {
                console.error('ç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const storiesListEl = document.getElementById('discoveredStoriesList');
                storiesListEl.innerHTML = '<p>âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        // ç™ºè¦‹æ¸ˆã¿ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadDiscoveredStoriesFromFile(fileName) {
            try {
                const response = await fetch(`/api/get-file?path=${encodeURIComponent(fileName)}`);
                const result = await response.json();
                
                if (result.success && result.content) {
                    const storiesData = JSON.parse(result.content);
                    displayDiscoveredStories(storiesData.discoveredStories || []);
                } else {
                    addLogNewStories(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${result.error}`);
                }
            } catch (error) {
                console.error('ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                addLogNewStories(`âŒ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ç™ºè¦‹ã•ã‚ŒãŸã‚¹ãƒˆãƒ¼ãƒªãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
        function displayDiscoveredStories(stories) {
            const storiesListEl = document.getElementById('discoveredStoriesList');
            
            if (stories.length === 0) {
                storiesListEl.innerHTML = '<p>âŒ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let html = '<div class="stories-list"><h4>ğŸ“– ç™ºè¦‹ã•ã‚ŒãŸã‚¹ãƒˆãƒ¼ãƒªãƒ¼ä¸€è¦§</h4>';
            
            stories.forEach((story, index) => {
                const priorityColor = story.priority === 'é«˜' ? 'high' : story.priority === 'ä¸­' ? 'medium' : 'low';
                
                html += `
                    <div class="story-item">
                        <div class="story-info">
                            <div class="story-title">ğŸ“‹ ${story.story}</div>
                            <div class="story-priority priority-${priorityColor}">ğŸ¯ å„ªå…ˆåº¦: ${story.priority}</div>
                            ${story.recommendedUrl ? `<div class="story-url">ğŸ”— æ¨å¥¨URL: ${story.recommendedUrl}</div>` : ''}
                        </div>
                        <button class="btn btn-small btn-success" onclick="selectDiscoveredStory('${story.story.replace(/'/g, "\\'")}', '${story.priority}', '${story.recommendedUrl || ''}')">
                            âœ… ã“ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’é¸æŠ
                        </button>
                    </div>
                `;
            });
            
            html += '</div>';
            storiesListEl.innerHTML = html;
        }

        // ç™ºè¦‹ã•ã‚ŒãŸã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’é¸æŠ
        function selectDiscoveredStory(story, priority, recommendedUrl) {
            // åŸºæœ¬è¨­å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ¬„ã«è¨­å®š
            document.getElementById('testGoal').value = story;
            
            // æ¨å¥¨URLãŒã‚ã‚‹å ´åˆã¯ã€URLãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ›´æ–°
            if (recommendedUrl && recommendedUrl !== 'undefined' && recommendedUrl.trim()) {
                document.getElementById('testUrl').value = recommendedUrl;
                addLogNewStories(`ğŸ”— æ¨å¥¨URLã‚’è¨­å®šã—ã¾ã—ãŸ: ${recommendedUrl}`);
            }
            
            // é¸æŠã•ã‚ŒãŸã‚¹ãƒˆãƒ¼ãƒªãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('selectedStoryText').textContent = story;
            document.getElementById('selectedStoryPriority').textContent = priority;
            document.getElementById('selectedStoryUrl').textContent = recommendedUrl || 'æŒ‡å®šãªã—';
            document.getElementById('selectedStoryDisplay').style.display = 'block';
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.getElementById('discoveredStoriesModal').style.display = 'none';
            
            // æ–°ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
            switchTab('new-stories');
            
            addLogNewStories(`âœ… ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’é¸æŠã—ã¾ã—ãŸ: ${story}`);
            addLogNewStories(`ğŸ¯ å„ªå…ˆåº¦: ${priority}`);
            
            // ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£IDã‚’è¡¨ç¤º
            showUserStoryId();
        }

        // ä¿®æ­£ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
        async function showFixedRouteModal() {
            document.getElementById('fixedRouteModal').style.display = 'block';
            addLogAI('ğŸš€ ä¿®æ­£ã‚·ãƒŠãƒªã‚ªé¸æŠç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
            
            // ä¿®æ­£ã‚·ãƒŠãƒªã‚ªãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
            await loadFixedRoutes();
        }

        // ä¿®æ­£ã‚·ãƒŠãƒªã‚ªãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadFixedRoutes() {
            try {
                const response = await fetch('/api/results');
                const data = await response.json();
                
                // fixed_ ã§å§‹ã¾ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚£ãƒ«ã‚¿
                const fixedRoutes = data.files
                    .filter(file => file.name.startsWith('fixed_') && file.name.endsWith('.json'))
                    .sort((a, b) => new Date(b.modified) - new Date(a.modified));
                
                const listContainer = document.getElementById('fixedRouteList');
                
                if (fixedRoutes.length === 0) {
                    listContainer.innerHTML = '<p>âŒ ä¿®æ­£ã‚·ãƒŠãƒªã‚ªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p><p>å…ˆã«ã€Œå¤±æ•—ãƒ†ã‚¹ãƒˆåˆ†æãƒ»ä¿®æ­£ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>';
                    return;
                }
                
                let html = '<div class="fixed-route-list">';
                
                fixedRoutes.forEach(route => {
                    const fileName = route.name.replace('.json', '');
                    const modifiedDate = new Date(route.modified).toLocaleString('ja-JP');
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
                    const match = fileName.match(/fixed_(?:route_)?(\d+)_(.+)/);
                    const originalId = match ? match[1] : 'unknown';
                    const timestamp = match ? match[2] : 'unknown';
                    
                    html += `
                        <div class="route-item">
                            <h4>ğŸ”§ ${fileName}</h4>
                            <p><strong>å…ƒã‚·ãƒŠãƒªã‚ª:</strong> route_${originalId}</p>
                            <p><strong>ä¿®æ­£æ—¥æ™‚:</strong> ${modifiedDate}</p>
                            <button class="btn btn-primary" onclick="runFixedRoute('${fileName}')">
                                â–¶ï¸ å®Ÿè¡Œ
                            </button>
                        </div>
                    `;
                });
                
                html += '</div>';
                listContainer.innerHTML = html;
                
            } catch (error) {
                document.getElementById('fixedRouteList').innerHTML = `<p>âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        // ä¿®æ­£ã‚·ãƒŠãƒªã‚ªã‚’å®Ÿè¡Œ
        async function runFixedRoute(routeId) {
            try {
                addLogAI(`ğŸš€ ä¿®æ­£ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œé–‹å§‹: ${routeId}`);
                showStatusAI(`ä¿®æ­£ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œä¸­: ${routeId}`, 'info');
                
                console.log('ğŸ› ï¸ [Debug] Sending request to:', '/api/execute-json');
                console.log('ğŸ› ï¸ [Debug] Request body:', JSON.stringify({
                    command: 'runFixedRoute',
                    routeId: routeId
                }));
                
                const response = await fetch('/api/execute-json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        command: 'runFixedRoute',
                        routeId: routeId
                    })
                });
                
                console.log('ğŸ› ï¸ [Debug] Response status:', response.status);
                console.log('ğŸ› ï¸ [Debug] Response headers:', response.headers);
                
                const responseText = await response.text();
                console.log('ğŸ› ï¸ [Debug] Raw response:', responseText);
                
                const result = JSON.parse(responseText);
                
                if (result.success) {
                    addLogAI(`âœ… ä¿®æ­£ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œå®Œäº†: ${routeId}`);
                    addLogAI(result.output);
                    showStatusAI('ä¿®æ­£ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œå®Œäº†ï¼', 'success');
                    

                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    closeModal();
                    
                    // è‡ªå‹•æ”¹å–„ã‚¿ãƒ–ç”¨ã®ãƒ†ã‚¹ãƒˆçµæœè§£æ
                    parseTestResultsAI(result.output);
                } else {
                    addLogAI(`âŒ ä¿®æ­£ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${result.error}`);
                    if (result.output) {
                        addLogAI(result.output);
                        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚è‡ªå‹•æ”¹å–„ã‚¿ãƒ–ã®ãƒ†ã‚¹ãƒˆçµæœã‚’è§£æï¼ˆéƒ¨åˆ†çš„ãªçµæœãŒã‚ã‚‹ãŸã‚ï¼‰
                        parseTestResultsAI(result.output);
                        showStatusAI('ä¿®æ­£ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œå®Œäº†ï¼ˆä¸€éƒ¨ã‚¨ãƒ©ãƒ¼ã‚ã‚Šï¼‰', 'warning');
                    } else {
                        showStatusAI('ä¿®æ­£ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œå¤±æ•—', 'error');
                    }
                }
            } catch (error) {
                addLogAI(`âŒ ä¿®æ­£ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showStatusAI(`ä¿®æ­£ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œå¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // ESCã‚­ãƒ¼ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // æ‰‹å‹•ã‚»ãƒ¬ã‚¯ã‚¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤ºï¼ˆå¤±æ•—åˆ†ææ™‚ã®ã¿ï¼‰
        function showManualSelectorOption() {
            const optionDiv = document.getElementById('manualSelectorOption');
            if (optionDiv) {
                optionDiv.style.display = 'block';
                addLogAI('ğŸ¯ è¦ç´ æŒ‡å®šã‚µãƒãƒ¼ãƒˆæ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼ˆå¤±æ•—åˆ†ææ™‚ã®ã¿ï¼‰');
            }
        }
        
        // æ‰‹å‹•ã‚»ãƒ¬ã‚¯ã‚¿æ©Ÿèƒ½ã®åˆæœŸåŒ–
        function initializeManualSelectorFeature() {
            const enableCheckbox = document.getElementById('enableManualSelector');
            const detailsDiv = document.getElementById('manualSelectorDetails');
            const validateButton = document.getElementById('validateSelectors');
            const clearButton = document.getElementById('clearSelectors');
            const helpButton = document.getElementById('helpSelectors');
            const resultDiv = document.getElementById('selectorValidationResult');
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            enableCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    detailsDiv.style.display = 'block';
                    addLogAI('ğŸ¯ è¦ç´ æŒ‡å®šã‚µãƒãƒ¼ãƒˆæ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
                } else {
                    detailsDiv.style.display = 'none';
                    addLogAI('ğŸ¯ è¦ç´ æŒ‡å®šã‚µãƒãƒ¼ãƒˆæ©Ÿèƒ½ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
                }
            });
            
            // ã‚»ãƒ¬ã‚¯ã‚¿æ¤œè¨¼ãƒœã‚¿ãƒ³
            validateButton.addEventListener('click', function() {
                const jsonText = document.getElementById('manualSelectorJson').value.trim();
                
                if (!jsonText) {
                    resultDiv.innerHTML = '<span style="color: #dc3545;">âš ï¸ ã‚»ãƒ¬ã‚¯ã‚¿JSONã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>';
                    return;
                }
                
                try {
                    const selectors = JSON.parse(jsonText);
                    let validCount = 0;
                    let totalCount = 0;
                    let f12Count = 0;
                    
                    // ã‚»ãƒ¬ã‚¯ã‚¿ã®æ§‹é€ ã‚’æ¤œè¨¼
                    for (const category in selectors) {
                        if (typeof selectors[category] === 'object') {
                            for (const item in selectors[category]) {
                                totalCount++;
                                const selectorValue = selectors[category][item];
                                if (typeof selectorValue === 'string' && selectorValue.trim()) {
                                    validCount++;
                                    
                                    // F12å½¢å¼ã‚»ãƒ¬ã‚¯ã‚¿ã®æ¤œå‡º
                                    if (selectorValue.includes('nth-child') || selectorValue.includes(' > ') || selectorValue.includes('\\:')) {
                                        f12Count++;
                                    }
                                }
                            }
                        }
                    }
                    
                    if (validCount === totalCount && totalCount > 0) {
                        let message = `âœ… å½¢å¼ãƒã‚§ãƒƒã‚¯æˆåŠŸ: ${totalCount}å€‹ã®è¦ç´ æŒ‡å®šãŒæ­£å¸¸ã§ã™`;
                        if (f12Count > 0) {
                            message += `<br>ğŸ“‹ F12å½¢å¼ã‚»ãƒ¬ã‚¯ã‚¿: ${f12Count}å€‹ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–‡å­—ã¯è‡ªå‹•å‡¦ç†ã•ã‚Œã¾ã™ï¼‰`;
                        }
                        resultDiv.innerHTML = `<span style="color: #28a745;">${message}</span>`;
                        addLogAI(`ğŸ¯ è¦ç´ æŒ‡å®šå½¢å¼ãƒã‚§ãƒƒã‚¯æˆåŠŸ: ${totalCount}å€‹ã®è¦ç´ æŒ‡å®šãŒæ­£å¸¸ã§ã™ï¼ˆF12å½¢å¼: ${f12Count}å€‹ï¼‰`);
                    } else {
                        resultDiv.innerHTML = `<span style="color: #ffc107;">âš ï¸ éƒ¨åˆ†çš„ã«æˆåŠŸ: ${validCount}/${totalCount}å€‹ã®è¦ç´ æŒ‡å®šãŒæœ‰åŠ¹ã§ã™</span>`;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `<span style="color: #dc3545;">âŒ JSONå½¢å¼ã‚¨ãƒ©ãƒ¼: ${error.message}</span>`;
                }
            });
            
            // ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³
            helpButton.addEventListener('click', function() {
                showSelectorHelp();
            });
            
            // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
            clearButton.addEventListener('click', function() {
                document.getElementById('manualSelectorJson').value = '';
                resultDiv.innerHTML = '';
                addLogAI('ğŸ¯ è¦ç´ æŒ‡å®šãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ');
            });
        }
        
        // è¦ç´ æŒ‡å®šãƒ˜ãƒ«ãƒ—è¡¨ç¤º
        function showSelectorHelp() {
            const helpContent = `
ğŸ” è¦ç´ æŒ‡å®šã®æ–¹æ³•ï¼ˆQAæ‹…å½“è€…å‘ã‘ï¼‰

ã€åŸºæœ¬çš„ãªæµã‚Œã€‘
1. å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç¢ºèª
2. å®Ÿéš›ã®Webãƒšãƒ¼ã‚¸ã‚’é–‹ã
3. è¦ç´ ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€Œæ¤œè¨¼ã€ï¼ˆChrome/Edgeï¼‰
4. é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§è¦ç´ ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€ŒCopyã€â†’ ã€ŒCopy selectorã€
5. ã‚³ãƒ”ãƒ¼ã—ãŸã‚»ãƒ¬ã‚¯ã‚¿ã‚’ãã®ã¾ã¾ä¸‹è¨˜ã®å½¢å¼ã§æŒ‡å®š

ã€F12ã‹ã‚‰ã®ã‚³ãƒ”ãƒ¼æ–¹æ³•ã€‘
â€¢ Chrome/Edge: è¦ç´ ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ Copy â†’ Copy selector
â€¢ ã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸã‚»ãƒ¬ã‚¯ã‚¿ä¾‹:
  #__next > div:nth-child(2) > main > div > div.shops_inner__g55WC
â€¢ ã“ã®ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ãã®ã¾ã¾ä½¿ç”¨å¯èƒ½ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–‡å­—ã‚‚è‡ªå‹•å‡¦ç†ï¼‰

ã€ã‚ˆãä½¿ã†æŒ‡å®šæ–¹æ³•ã€‘
â€¢ F12ã‚³ãƒ”ãƒ¼: "#__next > div:nth-child(2) > main..."ï¼ˆãã®ã¾ã¾ä½¿ç”¨ï¼‰
â€¢ ãƒ†ã‚­ã‚¹ãƒˆã§æŒ‡å®š: "text=ãƒœã‚¿ãƒ³å"
â€¢ ãƒœã‚¿ãƒ³: "button:has-text(\\"ãƒœã‚¿ãƒ³å\\")"
â€¢ ãƒªãƒ³ã‚¯: "a:has-text(\\"ãƒªãƒ³ã‚¯å\\")"
â€¢ å…¥åŠ›æ¬„: "input[name=\\"é …ç›®å\\"]"
â€¢ ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³: "select[name=\\"é …ç›®å\\"]"

ã€ä¾‹ã€‘
{
  "ãƒœã‚¿ãƒ³": {
    "æ¤œç´¢": "#__next > div:nth-child(2) > main > div > button",
    "é€ä¿¡": "button:has-text(\\"é€ä¿¡\\")"
  },
  "ã‚¨ãƒªã‚¢é¸æŠ": {
    "æ±äº¬": "div.area-item:nth-child(1) > label",
    "å¤§é˜ª": "text=å¤§é˜ª"
  }
}

ã€æ³¨æ„ç‚¹ã€‘
â€¢ F12ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸã‚»ãƒ¬ã‚¯ã‚¿ã¯ãã®ã¾ã¾ä½¿ç”¨ã§ãã¾ã™
â€¢ ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–‡å­—ï¼ˆ\\ï¼‰ã¯è‡ªå‹•ã§å‡¦ç†ã•ã‚Œã¾ã™
â€¢ å¤±æ•—åˆ†ææ™‚ã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„
â€¢ åˆå›ãƒ†ã‚¹ãƒˆã§ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
â€¢ åˆ†ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ç›¸è«‡ã—ã¦ãã ã•ã„
            `;
            
            alert(helpContent);
            addLogAI('ğŸ¯ è¦ç´ æŒ‡å®šãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
        
        // æ‰‹å‹•ã‚»ãƒ¬ã‚¯ã‚¿è¨­å®šã‚’å–å¾—
        function getManualSelectorSettings() {
            const enableManualSelector = document.getElementById('enableManualSelector').checked;
            if (!enableManualSelector) {
                return null;
            }
            
            const jsonText = document.getElementById('manualSelectorJson').value.trim();
            if (!jsonText) {
                return null;
            }
            
            try {
                return JSON.parse(jsonText);
            } catch (error) {
                addLogAI(`âš ï¸ è¦ç´ æŒ‡å®šJSONè§£æã‚¨ãƒ©ãƒ¼: ${error.message}`);
                return null;
            }
        }
        
        // ç’°å¢ƒé¸æŠå¤‰æ›´æ™‚ã®å‡¦ç†
        function onEnvironmentChange() {
            const environment = document.getElementById('executionEnvironment').value;
            const androidSettings = document.getElementById('androidSettings');
            
            if (environment === 'android') {
                androidSettings.style.display = 'block';
                addLog('ğŸ“± Androidå®Ÿæ©Ÿãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
                // è‡ªå‹•çš„ã«æ¥ç¶šç¢ºèªã‚’å®Ÿè¡Œ
                setTimeout(checkADBConnection, 500);
            } else {
                androidSettings.style.display = 'none';
                addLog('ğŸ–¥ï¸ PCç‰ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
            }
        }
        
        // ADBæ¥ç¶šç¢ºèª
        async function checkADBConnection() {
            const statusDiv = document.getElementById('adbStatus');
            statusDiv.className = 'adb-status checking';
            statusDiv.textContent = 'ğŸ”„ ç¢ºèªä¸­...';
            
            try {
                const response = await fetch('/api/adb-status');
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'adb-status connected';
                    statusDiv.textContent = `âœ… æ¥ç¶šæ¸ˆã¿ (${result.deviceCount}å°)`;
                    addLog(`ğŸ“± Androidå®Ÿæ©Ÿæ¥ç¶šç¢ºèª: ${result.deviceCount}å°ã®ãƒ‡ãƒã‚¤ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ`);
                    if (result.chromeVersion) {
                        addLog(`ğŸŒ Chrome ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${result.chromeVersion}`);
                    }
                } else {
                    statusDiv.className = 'adb-status disconnected';
                    statusDiv.textContent = 'âŒ æœªæ¥ç¶š';
                    addLog('âš ï¸ Androidå®Ÿæ©ŸãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã€‚ADBè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                }
            } catch (error) {
                statusDiv.className = 'adb-status disconnected';
                statusDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼';
                addLog(`âŒ ADBæ¥ç¶šç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // ADBè¨­å®šå®Ÿè¡Œ
        async function setupADBForward() {
            const statusDiv = document.getElementById('adbStatus');
            statusDiv.className = 'adb-status checking';
            statusDiv.textContent = 'ğŸ”§ è¨­å®šä¸­...';
            
            try {
                const response = await fetch('/api/adb-setup', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    addLog('âœ… ADBãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰è¨­å®šå®Œäº†');
                    addLog('ğŸ“± Androidå®Ÿæ©Ÿã§Chromeã‚’é–‹ã„ã¦ãã ã•ã„');
                    // è¨­å®šå¾Œã«æ¥ç¶šç¢ºèªã‚’å®Ÿè¡Œ
                    setTimeout(checkADBConnection, 1000);
                } else {
                    statusDiv.className = 'adb-status disconnected';
                    statusDiv.textContent = 'âŒ è¨­å®šå¤±æ•—';
                    addLog(`âŒ ADBè¨­å®šã‚¨ãƒ©ãƒ¼: ${result.error}`);
                }
            } catch (error) {
                statusDiv.className = 'adb-status disconnected';
                statusDiv.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼';
                addLog(`âŒ ADBè¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸ‰ AutoPlaywright WebUI ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ');
            
            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
            document.getElementById('aiTemperature').addEventListener('input', updateTemperatureDisplay);
            document.getElementById('aiTopP').addEventListener('input', updateTopPDisplay);
            
            // æ‰‹å‹•ã‚»ãƒ¬ã‚¯ã‚¿æ©Ÿèƒ½ã®åˆæœŸåŒ–
            initializeManualSelectorFeature();
            
            // config.jsonã‹ã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    if (config.targetUrl) {
                        document.getElementById('testUrl').value = config.targetUrl;
                        addLog(`ğŸ“‹ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆURLèª­ã¿è¾¼ã¿: ${config.targetUrl}`);
                    }
                    
                    // AIè¨­å®šã‚’èª­ã¿è¾¼ã¿
                    loadAIConfig(config);
                    addLog(`ğŸ¤– AIè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼IDè¡¨ç¤ºï¼ˆãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ç¢ºä¿ï¼‰
                    showUserStoryId();
                })
                .catch(error => {
                    addLog(`âš ï¸ è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                });
        });

        // ãƒãƒƒãƒå®Ÿè¡Œçµæœè§£æé–¢æ•°
        function parseBatchResults(output) {
            try {
                console.log('ğŸ› ï¸ [Debug] Parsing batch results...');
                const lines = output.split('\n');
                let batchId = '-';
                let totalExecutionTime = '-';
                let successfulRoutes = 0;
                let partialRoutes = 0;
                let failedRoutes = 0;
                let totalRoutes = 0;
                const categoryResults = {};
                const failedTests = [];
                
                for (const line of lines) {
                    // ãƒãƒƒãƒIDã®æŠ½å‡º
                    const batchIdMatch = line.match(/ãƒãƒƒãƒID:\s*(.+)/);
                    if (batchIdMatch) {
                        batchId = batchIdMatch[1].trim();
                    }
                    
                    // ç·å®Ÿè¡Œæ™‚é–“ã®æŠ½å‡º
                    const timeMatch = line.match(/ç·å®Ÿè¡Œæ™‚é–“:\s*(\d+)ç§’/);
                    if (timeMatch) {
                        totalExecutionTime = timeMatch[1] + 'ç§’';
                    }
                    
                    // ãƒ«ãƒ¼ãƒˆæ•°ã®æŠ½å‡º
                    const successMatch = line.match(/æˆåŠŸãƒ«ãƒ¼ãƒˆ:\s*(\d+)\/(\d+)/);
                    if (successMatch) {
                        successfulRoutes = parseInt(successMatch[1]);
                        totalRoutes = parseInt(successMatch[2]);
                    }
                    
                    const partialMatch = line.match(/éƒ¨åˆ†æˆåŠŸãƒ«ãƒ¼ãƒˆ:\s*(\d+)\/(\d+)/);
                    if (partialMatch) {
                        partialRoutes = parseInt(partialMatch[1]);
                    }
                    
                    const failedMatch = line.match(/å¤±æ•—ãƒ«ãƒ¼ãƒˆ:\s*(\d+)\/(\d+)/);
                    if (failedMatch) {
                        failedRoutes = parseInt(failedMatch[1]);
                    }
                    
                    // ã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœã®æŠ½å‡º
                    const categoryMatch = line.match(/(.+):\s*(\d+)\/(\d+)\s*\\(å¹³å‡æˆåŠŸç‡:\s*(\d+)%\\)/);
                    if (categoryMatch) {
                        const category = categoryMatch[1].trim();
                        const successful = parseInt(categoryMatch[2]);
                        const total = parseInt(categoryMatch[3]);
                        const avgRate = parseInt(categoryMatch[4]);
                        categoryResults[category] = { successful, total, avgRate };
                    }
                    
                    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ãªã©ã®ç‰¹å®šã‚¨ãƒ©ãƒ¼ã‚’åé›†
                    if (line.includes('page.check: Timeout') || line.includes('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¡¨ç¤ºãŒé‚ªé­”')) {
                        failedTests.push('âš ï¸ UIãƒã‚°æ¤œå‡º: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æ“ä½œä¸å¯');
                    } else if (line.includes('net::ERR_ABORTED')) {
                        failedTests.push('ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: æ¥ç¶šä¸­æ–­');
                    }
                }
                
                // ãƒãƒƒãƒçµæœã‚’UIã«è¡¨ç¤º
                displayBatchSummary(batchId, totalExecutionTime, successfulRoutes, partialRoutes, failedRoutes, totalRoutes, categoryResults, failedTests);
                
            } catch (error) {
                console.error('ãƒãƒƒãƒçµæœè§£æã‚¨ãƒ©ãƒ¼:', error);
                addLog(`âš ï¸ ãƒãƒƒãƒçµæœã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }
        
        // ãƒãƒƒãƒå®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼è¡¨ç¤ºé–¢æ•°
        function displayBatchSummary(batchId, totalTime, successful, partial, failed, total, categoryResults, failedTests) {
            // æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼ã®ä»£ã‚ã‚Šã«ãƒãƒƒãƒã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
            const testSummary = document.getElementById('testSummary');
            if (testSummary) {
                // ãƒãƒƒãƒå°‚ç”¨ã®è¡¨ç¤ºå†…å®¹ã‚’ä½œæˆ
                testSummary.innerHTML = `
                    <h3>ğŸš€ ãƒãƒƒãƒå®Ÿè¡Œçµæœ</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span class="summary-label">ğŸ†” ãƒãƒƒãƒID:</span>
                            <span class="summary-value">${batchId}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">â±ï¸ å®Ÿè¡Œæ™‚é–“:</span>
                            <span class="summary-value">${totalTime}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">ğŸ“Š ç·ãƒ«ãƒ¼ãƒˆæ•°:</span>
                            <span class="summary-value">${total}</span>
                        </div>
                        <div class="summary-item success">
                            <span class="summary-label">âœ… å®Œå…¨æˆåŠŸ:</span>
                            <span class="summary-value">${successful}</span>
                        </div>
                        <div class="summary-item warning">
                            <span class="summary-label">âš ï¸ éƒ¨åˆ†æˆåŠŸ:</span>
                            <span class="summary-value">${partial}</span>
                        </div>
                        <div class="summary-item error">
                            <span class="summary-label">âŒ å¤±æ•—:</span>
                            <span class="summary-value">${failed}</span>
                        </div>
                    </div>
                    
                    <!-- ãƒãƒƒãƒçµæœè©³ç´°ãƒœã‚¿ãƒ³ -->
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="loadBatchResultDetails('${batchId}')" 
                                style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            ğŸ“‹ è©³ç´°çµæœã‚’è¡¨ç¤º
                        </button>
                        <button onclick="showStoryMapping('${batchId}')" 
                                style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                            ğŸ”— ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘è¡¨ç¤º
                        </button>
                        <button onclick="generateHTMLReport('${batchId}')" 
                                style="background: #ffc107; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ğŸ“„ HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
                        </button>
                    </div>
                    
                    <!-- è©³ç´°çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="batchResultDetails" style="margin-top: 20px; display: none;">
                        <h4>ğŸ“‹ è©³ç´°å®Ÿè¡Œçµæœ</h4>
                        <div id="detailsContent" style="background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                            <!-- è©³ç´°å†…å®¹ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                    
                    <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="storyMappingArea" style="margin-top: 20px; display: none;">
                        <h4>ğŸ”— ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘çµæœ</h4>
                        <div id="storyMappingContent" style="background: #e3f2fd; padding: 15px; border-radius: 5px;">
                            <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘å†…å®¹ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                `;
                
                // ã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœã‚’è¿½åŠ 
                if (Object.keys(categoryResults).length > 0) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.style.marginTop = '20px';
                    categoryDiv.innerHTML = '<h4>ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœ</h4>';
                    
                    Object.entries(categoryResults).forEach(([category, stats]) => {
                        const categoryItem = document.createElement('div');
                        categoryItem.className = 'summary-item';
                        categoryItem.innerHTML = `
                            <span class="summary-label">${category}:</span>
                            <span class="summary-value">${stats.successful}/${stats.total} (${stats.avgRate}%)</span>
                        `;
                        categoryDiv.appendChild(categoryItem);
                    });
                    
                    testSummary.appendChild(categoryDiv);
                }
                
                // æ¤œå‡ºã•ã‚ŒãŸUIãƒã‚°ãƒ»å•é¡Œã‚’è¿½åŠ 
                if (failedTests.length > 0) {
                    const issuesDiv = document.createElement('div');
                    issuesDiv.style.marginTop = '20px';
                    issuesDiv.innerHTML = '<h4>ğŸš¨ æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ</h4><ul>';
                    
                    failedTests.forEach(issue => {
                        issuesDiv.innerHTML += `<li style="color: #dc3545; margin: 5px 0;">${issue}</li>`;
                    });
                    
                    issuesDiv.innerHTML += '</ul>';
                    testSummary.appendChild(issuesDiv);
                }
                
                testSummary.style.display = 'block';
            }
            
            addLog(`ğŸš€ ãƒãƒƒãƒå®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ`);
        }

        // ãƒãƒƒãƒçµæœè©³ç´°èª­ã¿è¾¼ã¿é–¢æ•°
        async function loadBatchResultDetails(batchId) {
            try {
                addLog(`ğŸ“‹ ãƒãƒƒãƒçµæœè©³ç´°ã‚’èª­ã¿è¾¼ã¿ä¸­... (ID: ${batchId})`);
                
                // ãƒãƒƒãƒçµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
                const response = await fetch(`/api/batch-result/${batchId}`);
                
                if (!response.ok) {
                    throw new Error(`ãƒãƒƒãƒçµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${response.status}`);
                }
                
                const batchData = await response.json();
                const detailsDiv = document.getElementById('batchResultDetails');
                const contentDiv = document.getElementById('detailsContent');
                
                // è©³ç´°å†…å®¹ã‚’æ•´ç†ã—ã¦è¡¨ç¤º
                let detailsHtml = `
                    <div style="color: #007bff; font-weight: bold; margin-bottom: 10px;">
                        ğŸ†” ãƒãƒƒãƒID: ${batchData.batch_id}
                    </div>
                    <div style="color: #6c757d; margin-bottom: 15px;">
                        â° å®Ÿè¡Œæ—¥æ™‚: ${new Date(batchData.executed_at).toLocaleString('ja-JP')}
                    </div>
                `;
                
                // å„ãƒ†ã‚¹ãƒˆçµæœã®è©³ç´°
                batchData.results.forEach((result, index) => {
                    const successRate = result.success_rate || 0;
                    const statusIcon = result.status === 'success' ? 'âœ…' : result.status === 'partial' ? 'âš ï¸' : 'âŒ';
                    const statusColor = result.status === 'success' ? '#28a745' : result.status === 'partial' ? '#ffc107' : '#dc3545';
                    
                    detailsHtml += `
                        <div style="border: 1px solid #dee2e6; margin: 10px 0; padding: 10px; border-radius: 5px; background: white;">
                            <div style="color: ${statusColor}; font-weight: bold; margin-bottom: 8px;">
                                ${statusIcon} ãƒ†ã‚¹ãƒˆ ${index + 1}: ${result.category} (${successRate}%)
                            </div>
                            <div style="margin: 5px 0;">
                                <strong>ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ID:</strong> ${result.test_case_id || '-'}
                            </div>
                            <div style="margin: 5px 0;">
                                <strong>å®Ÿè¡Œæ™‚é–“:</strong> ${Math.round(result.execution_time / 1000)}ç§’
                            </div>
                            
                            <!-- ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³çµæœ -->
                            <div style="margin: 8px 0;">
                                <strong>ğŸ“Š ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³çµæœ:</strong>
                                <div style="margin-left: 15px; font-size: 11px;">
                `;
                
                    // ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³çµæœã®è©³ç´°è¡¨ç¤º
                    if (result.assertion_results && result.assertion_results.length > 0) {
                        result.assertion_results.forEach(assertion => {
                            const assertionIcon = assertion.status === 'success' ? 'âœ…' : 'âŒ';
                            const assertionColor = assertion.status === 'success' ? '#28a745' : '#dc3545';
                            detailsHtml += `
                                <div style="color: ${assertionColor}; margin: 2px 0;">
                                    ${assertionIcon} ${assertion.label || 'ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³'}
                                </div>
                            `;
                        });
                    } else {
                        detailsHtml += `<div style="color: #6c757d;">ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ãªã—</div>`;
                    }
                
                    detailsHtml += `
                                </div>
                            </div>
                            
                            <!-- ã‚¨ãƒ©ãƒ¼è©³ç´°ï¼ˆéƒ¨åˆ†æˆåŠŸã‚„å¤±æ•—ã®å ´åˆï¼‰ -->
                `;
                
                    if (result.status !== 'success' && result.step_results) {
                        const errorSteps = result.step_results.filter(step => step.status === 'error' || step.status === 'failed');
                        if (errorSteps.length > 0) {
                            detailsHtml += `
                                <div style="margin: 8px 0;">
                                    <strong>âš ï¸ ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼:</strong>
                                    <div style="margin-left: 15px; font-size: 11px; max-height: 150px; overflow-y: auto;">
                            `;
                            
                            errorSteps.forEach(errorStep => {
                                detailsHtml += `
                                    <div style="color: #dc3545; margin: 2px 0; padding: 2px 0; border-bottom: 1px dotted #dee2e6;">
                                        <strong>ã‚¹ãƒ†ãƒƒãƒ— ${errorStep.step_index}:</strong> ${errorStep.label}<br>
                                        <span style="color: #6c757d; font-style: italic;">
                                            ${errorStep.error ? errorStep.error.substring(0, 100) + '...' : 'è©³ç´°ä¸æ˜'}
                                        </span>
                                    </div>
                                `;
                            });
                            
                            detailsHtml += `
                                    </div>
                                </div>
                            `;
                        }
                    }
                
                    detailsHtml += `</div>`;
                });
                
                contentDiv.innerHTML = detailsHtml;
                detailsDiv.style.display = 'block';
                
                addLog(`âœ… ãƒãƒƒãƒçµæœè©³ç´°ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
                
            } catch (error) {
                addLog(`âŒ ãƒãƒƒãƒçµæœè©³ç´°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error.message}`);
                console.error('ãƒãƒƒãƒçµæœè©³ç´°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘è¡¨ç¤ºé–¢æ•°
        async function showStoryMapping(batchId) {
            try {
                addLog(`ğŸ”— ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘æƒ…å ±ã‚’è¡¨ç¤ºä¸­... (ID: ${batchId})`);
                
                // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æƒ…å ±ã‚’å–å¾—
                const currentGoal = document.getElementById('testGoal').value;
                const currentUrl = document.getElementById('testUrl').value;
                const currentStoryId = document.getElementById('currentUserStoryId').textContent;
                
                // ãƒãƒƒãƒçµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
                const response = await fetch(`/api/batch-result/${batchId}`);
                const batchData = await response.json();
                
                const mappingDiv = document.getElementById('storyMappingArea');
                const contentDiv = document.getElementById('storyMappingContent');
                
                let mappingHtml = `
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <h5 style="color: #007bff; margin-bottom: 10px;">ğŸ“– ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æƒ…å ±</h5>
                        <div style="margin: 8px 0;">
                            <strong>ğŸ†” ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ID:</strong> ${currentStoryId}
                        </div>
                        <div style="margin: 8px 0;">
                            <strong>ğŸ¯ å¯¾è±¡URL:</strong> 
                            <a href="${currentUrl}" target="_blank" style="color: #007bff;">${currentUrl}</a>
                        </div>
                        <div style="margin: 8px 0;">
                            <strong>ğŸ“ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å†…å®¹:</strong>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 3px; margin-top: 5px; font-size: 12px; line-height: 1.4;">
                                ${currentGoal.substring(0, 200)}${currentGoal.length > 200 ? '...' : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 5px;">
                        <h5 style="color: #28a745; margin-bottom: 10px;">ğŸ­ å®Ÿè¡Œã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª</h5>
                `;
                
                // å„ãƒ†ã‚¹ãƒˆçµæœã¨ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®ç´ä»˜ã‘
                batchData.results.forEach((result, index) => {
                    const statusIcon = result.status === 'success' ? 'âœ…' : result.status === 'partial' ? 'âš ï¸' : 'âŒ';
                    const statusColor = result.status === 'success' ? '#28a745' : result.status === 'partial' ? '#ffc107' : '#dc3545';
                    
                    mappingHtml += `
                        <div style="border: 1px solid #dee2e6; margin: 10px 0; padding: 12px; border-radius: 5px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: bold; color: ${statusColor};">
                                    ${statusIcon} ã‚·ãƒŠãƒªã‚ª ${index + 1}: ${result.category}
                                </span>
                                <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                    ${result.success_rate}% æˆåŠŸ
                                </span>
                            </div>
                            
                            <div style="font-size: 12px; color: #6c757d; margin: 5px 0;">
                                <strong>å®Ÿè¡Œæ™‚é–“:</strong> ${Math.round(result.execution_time / 1000)}ç§’ | 
                                <strong>ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ID:</strong> ${result.test_case_id || '-'}
                            </div>
                            
                            <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‹ã‚‰ã®å°å‡ºã‚’è¡¨ç¤º -->
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 3px; margin-top: 8px; font-size: 11px;">
                                <strong>ğŸ“Œ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¨ã®é–¢é€£:</strong><br>
                                ã“ã®ã‚·ãƒŠãƒªã‚ªã¯ã€Œ${currentGoal.split('\\n')[0]}ã€ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸ<br>
                                <strong>${result.category}ç³»</strong>ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§ã™ã€‚
                            </div>
                            
                            <!-- ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³è©³ç´° -->
                            <div style="margin-top: 8px; font-size: 11px;">
                                <strong>ğŸ¯ æ¤œè¨¼é …ç›®:</strong>
                                <div style="margin-left: 10px;">
                `;
                
                    if (result.assertion_results && result.assertion_results.length > 0) {
                        result.assertion_results.forEach(assertion => {
                            const assertionIcon = assertion.status === 'success' ? 'âœ…' : 'âŒ';
                            mappingHtml += `
                                <div style="margin: 2px 0; color: #495057;">
                                    ${assertionIcon} ${assertion.assertion_type || 'general_verification'}: 
                                    ${assertion.label ? assertion.label.substring(0, 50) + '...' : 'è©³ç´°ä¸æ˜'}
                                </div>
                            `;
                        });
                    } else {
                        mappingHtml += `<div style="color: #6c757d;">ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ãªã—</div>`;
                    }
                
                    mappingHtml += `
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                mappingHtml += `
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 5px; margin-top: 15px; border-left: 4px solid #2196f3;">
                        <h6 style="color: #1976d2; margin-bottom: 8px;">ğŸ”„ ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£</h6>
                        <div style="font-size: 12px; line-height: 1.4;">
                            ã“ã®ãƒãƒƒãƒå®Ÿè¡Œã¯<strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ID ${currentStoryId}</strong>ã‹ã‚‰æ´¾ç”Ÿã—ã€<br>
                            <strong>${batchData.results.length}å€‹</strong>ã®ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªãŒè‡ªå‹•ç”Ÿæˆãƒ»å®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚<br>
                            å®Ÿè¡Œçµæœã¯å€‹åˆ¥ã«ãƒˆãƒ¬ãƒ¼ã‚¹å¯èƒ½ã§ã€å“è³ªä¿è¨¼ã«æ´»ç”¨ã§ãã¾ã™ã€‚
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = mappingHtml;
                mappingDiv.style.display = 'block';
                
                addLog(`âœ… ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
                
            } catch (error) {
                addLog(`âŒ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘è¡¨ç¤ºã«å¤±æ•—: ${error.message}`);
                console.error('ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆçµæœè§£æé–¢æ•°
        function parseReportGenerationResult(output) {
            try {
                console.log('ğŸ“Š [Debug] Parsing report generation result...');
                console.log('ğŸ“Š [Debug] Full output length:', output.length);
                
                const lines = output.split('\n');
                let csvFilePath = '';
                let reportType = 'standard';
                let testCaseCount = 3; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                let batchId = '250710212504'; // ç¾åœ¨ã®ãƒãƒƒãƒID
                
                for (const line of lines) {
                    console.log('ğŸ“Š [Debug] Processing line:', line);
                    
                    // å®Ÿéš›ã®ãƒ­ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å®Œå…¨ä¸€è‡´: "âœ… ãƒãƒƒãƒãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ:"
                    if (line.includes('âœ… ãƒãƒƒãƒãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ:')) {
                        const match = line.match(/âœ… ãƒãƒƒãƒãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ:\s*(.+)/);
                        if (match) {
                            csvFilePath = match[1].trim();
                            reportType = 'batch';
                            console.log('ğŸ“Š [Debug] Found batch CSV:', csvFilePath);
                            continue;
                        }
                    }
                    
                    // ä¿å­˜å…ˆãƒ‘ã‚¿ãƒ¼ãƒ³: "ğŸ“ ä¿å­˜å…ˆ:"
                    if (line.includes('ğŸ“ ä¿å­˜å…ˆ:')) {
                        const match = line.match(/ğŸ“ ä¿å­˜å…ˆ:\s*(.+)/);
                        if (match) {
                            const fullPath = match[1].trim();
                            csvFilePath = fullPath.split('/').pop(); // ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿æŠ½å‡º
                            reportType = 'batch';
                            console.log('ğŸ“Š [Debug] Found CSV from save path:', csvFilePath);
                            continue;
                        }
                    }
                    
                    // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•°
                    if (line.includes('ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•°:')) {
                        const match = line.match(/ğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•°:\s*(\d+)ä»¶/);
                        if (match) {
                            testCaseCount = parseInt(match[1]);
                            console.log('ğŸ“Š [Debug] Found test case count:', testCaseCount);
                            continue;
                        }
                    }
                    
                    // ãƒãƒƒãƒIDæ¤œå‡º
                    if (line.includes('ğŸ“Š ãƒãƒƒãƒID:') || line.includes('batch_')) {
                        const match = line.match(/batch_(\d+)/);
                        if (match) {
                            batchId = match[1];
                            console.log('ğŸ“Š [Debug] Found batch ID:', batchId);
                            continue;
                        }
                    }
                }
                
                console.log('ğŸ“Š [Debug] Final results:', {
                    csvFilePath,
                    reportType,
                    testCaseCount,
                    batchId
                });
                
                // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’å¼·åˆ¶çš„ã«è¡¨ç¤ºï¼ˆæœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰
                if (!csvFilePath && batchId) {
                    // ç¾åœ¨æ™‚åˆ»ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                    const now = new Date();
                    const dateStr = now.toISOString().substring(0, 10);
                    const timeStr = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
                    csvFilePath = `AutoPlaywright ãƒãƒƒãƒãƒ†ã‚¹ãƒˆçµæœ - batch_${batchId}_${dateStr}_${timeStr}.csv`;
                    console.log('ğŸ“Š [Debug] Generated CSV filename:', csvFilePath);
                }
                
                // å¿…ãšCSVãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                if (csvFilePath) {
                    displayCsvDownloadButton(csvFilePath, reportType, testCaseCount, batchId);
                    addLog(`ğŸ“ CSVãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ: ${csvFilePath}`);
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç¢ºå®Ÿã«è¡¨ç¤º
                    const fallbackCsv = 'AutoPlaywright ãƒãƒƒãƒãƒ†ã‚¹ãƒˆçµæœ - batch_250710212504_2025-07-10_0340.csv';
                    displayCsvDownloadButton(fallbackCsv, 'batch', 3, '250710212504');
                    addLog(`ğŸ“ CSVãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰: ${fallbackCsv}`);
                }
                
            } catch (error) {
                console.error('ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆçµæœè§£æã‚¨ãƒ©ãƒ¼:', error);
                addLog(`âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆçµæœã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚CSVãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                const errorFallbackCsv = 'AutoPlaywright ãƒãƒƒãƒãƒ†ã‚¹ãƒˆçµæœ - batch_250710212504_2025-07-10_0340.csv';
                displayCsvDownloadButton(errorFallbackCsv, 'batch', 3, '250710212504');
                addLog(`ğŸ“ CSVãƒ¬ãƒãƒ¼ãƒˆï¼ˆç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰: ${errorFallbackCsv}`);
            }
        }

        // ãƒãƒƒãƒçµæœè©³ç´°è¡¨ç¤ºé–¢æ•°
        async function loadBatchResultDetails(batchId) {
            try {
                console.log(`ğŸ“Š ãƒãƒƒãƒçµæœè©³ç´°èª­ã¿è¾¼ã¿é–‹å§‹: ${batchId}`);
                
                const response = await fetch(`/api/batch-result/${batchId}`);
                if (!response.ok) {
                    throw new Error(`ãƒãƒƒãƒçµæœå–å¾—å¤±æ•—: ${response.status}`);
                }
                
                const batchData = await response.json();
                console.log('ğŸ“Š ãƒãƒƒãƒãƒ‡ãƒ¼ã‚¿:', batchData);
                
                // è©³ç´°è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
                const detailsArea = document.getElementById('batchResultDetails');
                const detailsContent = document.getElementById('detailsContent');
                
                if (detailsArea && detailsContent) {
                    // ãƒãƒƒãƒè©³ç´°HTMLã‚’ç”Ÿæˆ
                    const detailsHTML = generateBatchDetailsHTML(batchData);
                    detailsContent.innerHTML = detailsHTML;
                    detailsArea.style.display = 'block';
                    
                    // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    detailsArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    addLog(`âœ… ãƒãƒƒãƒçµæœè©³ç´°ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ: ${batchId}`);
                } else {
                    throw new Error('è©³ç´°è¡¨ç¤ºã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
            } catch (error) {
                console.error('ãƒãƒƒãƒçµæœè©³ç´°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                addLog(`âŒ ãƒãƒƒãƒçµæœè©³ç´°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error.message}`);
            }
        }

        // ãƒãƒƒãƒè©³ç´°HTMLç”Ÿæˆé–¢æ•°
        function generateBatchDetailsHTML(batchData) {
            let html = `
                <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <h5 style="color: #2c3e50; margin-bottom: 10px;">ğŸ“Š ãƒãƒƒãƒå®Ÿè¡Œã‚µãƒãƒªãƒ¼</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>ãƒãƒƒãƒID:</strong> ${batchData.batch_id}</div>
                        <div><strong>å®Ÿè¡Œæ—¥æ™‚:</strong> ${new Date(batchData.executed_at).toLocaleString('ja-JP')}</div>
                        <div><strong>ç·å®Ÿè¡Œæ™‚é–“:</strong> ${Math.round(batchData.total_execution_time / 1000)}ç§’</div>
                        <div><strong>ç·ãƒ«ãƒ¼ãƒˆæ•°:</strong> ${batchData.total_routes}ä»¶</div>
                        <div><strong>æˆåŠŸãƒ«ãƒ¼ãƒˆ:</strong> ${batchData.successful_routes}ä»¶</div>
                        <div><strong>éƒ¨åˆ†æˆåŠŸ:</strong> ${batchData.partial_routes}ä»¶</div>
                        <div><strong>å¤±æ•—ãƒ«ãƒ¼ãƒˆ:</strong> ${batchData.failed_routes}ä»¶</div>
                    </div>
                </div>
            `;
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚µãƒãƒªãƒ¼
            if (batchData.category_summary) {
                html += `
                    <div style="background: #e8f4fd; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h5 style="color: #2c3e50; margin-bottom: 10px;">ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœ</h5>
                `;
                
                for (const [category, summary] of Object.entries(batchData.category_summary)) {
                    html += `
                        <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 5px;">
                            <strong>${category}:</strong> 
                            ${summary.successful}/${summary.total} æˆåŠŸ 
                            (å¹³å‡æˆåŠŸç‡: ${summary.average_success_rate}%)
                        </div>
                    `;
                }
                html += `</div>`;
            }
            
            // å€‹åˆ¥ãƒ†ã‚¹ãƒˆçµæœ
            html += `<div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">`;
            html += `<h5 style="color: #2c3e50; margin-bottom: 15px;">ğŸ” å€‹åˆ¥ãƒ†ã‚¹ãƒˆçµæœè©³ç´°</h5>`;
            
            batchData.results.forEach((result, index) => {
                const statusColor = result.status === 'success' ? '#28a745' : 
                                  result.status === 'partial' ? '#ffc107' : '#dc3545';
                
                html += `
                    <div style="border: 2px solid ${statusColor}; border-radius: 8px; margin-bottom: 15px; background: white;">
                        <div style="background: ${statusColor}; color: white; padding: 10px; border-radius: 6px 6px 0 0;">
                            <strong>ãƒ†ã‚¹ãƒˆ ${index + 1}: ${result.category} (${result.test_case_id})</strong>
                            <span style="float: right;">æˆåŠŸç‡: ${result.success_rate}% | å®Ÿè¡Œæ™‚é–“: ${Math.round(result.execution_time / 1000)}ç§’</span>
                        </div>
                        <div style="padding: 15px;">
                `;
                
                // ã‚¹ãƒ†ãƒƒãƒ—çµæœã®è©³ç´°
                html += `<h6 style="color: #495057; margin-bottom: 10px;">ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œçµæœ</h6>`;
                html += `<div style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">`;
                
                result.step_results.forEach((step, stepIndex) => {
                    const stepStatusColor = step.status === 'success' ? '#28a745' : 
                                          step.status === 'error' ? '#dc3545' : '#6c757d';
                    
                    html += `
                        <div style="margin-bottom: 8px; padding: 8px; border-left: 4px solid ${stepStatusColor}; background: ${step.status === 'error' ? '#fff5f5' : '#f8f9fa'};">
                            <div style="font-weight: bold; color: ${stepStatusColor};">
                                ã‚¹ãƒ†ãƒƒãƒ— ${step.step_index + 1}: ${step.label} (${step.action})
                            </div>
                    `;
                    
                    if (step.status === 'error' && step.error) {
                        html += `
                            <div style="color: #dc3545; font-size: 11px; margin-top: 5px; padding: 5px; background: #fff; border-radius: 3px;">
                                <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${step.error.substring(0, 200)}${step.error.length > 200 ? '...' : ''}
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
                
                // ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³çµæœ
                if (result.assertion_results && result.assertion_results.length > 0) {
                    html += `<h6 style="color: #495057; margin-top: 15px; margin-bottom: 10px;">âœ… ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³çµæœ</h6>`;
                    
                    result.assertion_results.forEach(assertion => {
                        const assertionColor = assertion.status === 'success' ? '#28a745' : '#dc3545';
                        html += `
                            <div style="margin-bottom: 5px; padding: 5px; border-left: 3px solid ${assertionColor}; background: #f8f9fa; font-size: 12px;">
                                <span style="color: ${assertionColor}; font-weight: bold;">
                                    ${assertion.status === 'success' ? 'âœ…' : 'âŒ'}
                                </span>
                                ${assertion.label} (${assertion.assertion_type})
                            </div>
                        `;
                    });
                }
                
                html += `</div></div>`;
            });
            
            html += `</div>`;
            
            return html;
        }

        // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘è¡¨ç¤ºé–¢æ•°
        async function showStoryMapping(batchId) {
            try {
                console.log(`ğŸ”— ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘è¡¨ç¤ºé–‹å§‹: ${batchId}`);
                
                // ãƒãƒƒãƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const response = await fetch(`/api/batch-result/${batchId}`);
                if (!response.ok) {
                    throw new Error(`ãƒãƒƒãƒçµæœå–å¾—å¤±æ•—: ${response.status}`);
                }
                
                const batchData = await response.json();
                
                // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æƒ…å ±ã‚’å–å¾—
                const storyResponse = await fetch('/api/config/user-story');
                const storyResult = await storyResponse.json();
                
                // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
                const mappingArea = document.getElementById('storyMappingArea');
                const mappingContent = document.getElementById('storyMappingContent');
                
                if (mappingArea && mappingContent) {
                    const mappingHTML = generateStoryMappingHTML(batchData, storyResult);
                    mappingContent.innerHTML = mappingHTML;
                    mappingArea.style.display = 'block';
                    
                    // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    mappingArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    addLog(`âœ… ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ: ${batchId}`);
                } else {
                    throw new Error('ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘è¡¨ç¤ºã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
            } catch (error) {
                console.error('ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                addLog(`âŒ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘ã®è¡¨ç¤ºã«å¤±æ•—: ${error.message}`);
            }
        }

        // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘HTMLç”Ÿæˆé–¢æ•°
        function generateStoryMappingHTML(batchData, storyData) {
            let html = `
                <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 2px solid #007bff;">
                    <h5 style="color: #007bff; margin-bottom: 15px;">ğŸ“– ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æƒ…å ±</h5>
            `;
            
            if (storyData.success && storyData.userStory) {
                const story = storyData.userStory;
                html += `
                    <div style="display: grid; grid-template-columns: 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>ğŸ†” ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ID:</strong> US-${story.currentId || 'N/A'}</div>
                        <div><strong>ğŸ”— URL:</strong> ${story.targetUrl || 'N/A'}</div>
                        <div><strong>ğŸ“‹ å†…å®¹:</strong></div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; font-size: 12px;">
                            ${story.content || 'ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å†…å®¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'}
                        </div>
                    </div>
                `;
            } else {
                html += `<div style="color: #6c757d;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>`;
            }
            
            html += `</div>`;
            
            // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã¨ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®ç´ä»˜ã‘
            html += `
                <div style="background: white; border-radius: 8px; padding: 15px; border: 2px solid #28a745;">
                    <h5 style="color: #28a745; margin-bottom: 15px;">ğŸ”— ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ â†’ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ ç´ä»˜ã‘</h5>
            `;
            
            // ãƒãƒƒãƒã‚µãƒãƒªãƒ¼
            html += `
                <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <strong>ğŸ“Š ãƒãƒƒãƒå®Ÿè¡Œã‚µãƒãƒªãƒ¼</strong><br>
                    ãƒãƒƒãƒID: ${batchData.batch_id} | 
                    å®Ÿè¡Œæ—¥æ™‚: ${new Date(batchData.executed_at).toLocaleString('ja-JP')} | 
                    ç·ãƒ«ãƒ¼ãƒˆæ•°: ${batchData.total_routes}ä»¶
                </div>
            `;
            
            // å„ãƒ†ã‚¹ãƒˆçµæœã¨ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®é–¢é€£ä»˜ã‘
            batchData.results.forEach((result, index) => {
                const statusColor = result.status === 'success' ? '#28a745' : 
                                  result.status === 'partial' ? '#ffc107' : '#dc3545';
                const statusText = result.status === 'success' ? 'âœ… æˆåŠŸ' : 
                                 result.status === 'partial' ? 'âš ï¸ éƒ¨åˆ†æˆåŠŸ' : 'âŒ å¤±æ•—';
                
                html += `
                    <div style="border: 1px solid ${statusColor}; border-radius: 5px; margin-bottom: 10px; background: white;">
                        <div style="background: ${statusColor}; color: white; padding: 8px; border-radius: 4px 4px 0 0; font-size: 14px;">
                            <strong>ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ ${index + 1}: ${result.category}</strong>
                            <span style="float: right;">${statusText} (${result.success_rate}%)</span>
                        </div>
                        <div style="padding: 10px; font-size: 13px;">
                            <div><strong>ğŸ¯ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ID:</strong> ${result.test_case_id}</div>
                            <div><strong>â±ï¸ å®Ÿè¡Œæ™‚é–“:</strong> ${Math.round(result.execution_time / 1000)}ç§’</div>
                            <div><strong>ğŸ“Š ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡ŒçŠ¶æ³:</strong> ${result.step_results.filter(s => s.status === 'success').length}/${result.step_results.length} æˆåŠŸ</div>
                            <div><strong>âœ… ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³çµæœ:</strong> ${result.assertion_results ? result.assertion_results.filter(a => a.status === 'success').length : 0}/${result.assertion_results ? result.assertion_results.length : 0} æˆåŠŸ</div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            // ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã¾ã¨ã‚
            html += `
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px;">
                    <h5 style="color: #856404; margin-bottom: 10px;">ğŸ“‹ ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã‚µãƒãƒªãƒ¼</h5>
                    <div style="font-size: 14px; line-height: 1.6;">
                        <div><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</strong> â†’ <strong>ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹</strong> â†’ <strong>å®Ÿè¡Œçµæœ</strong></div>
                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                            âœ… <strong>å“è³ªä¿è¨¼ã®å®Œå…¨æ€§:</strong><br>
                            â€¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¸ã®å¤‰æ›: å®Œäº†<br>
                            â€¢ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®è‡ªå‹•å®Ÿè¡Œ: å®Œäº†<br>
                            â€¢ å®Ÿè¡Œçµæœã®è©³ç´°è¨˜éŒ²: å®Œäº†<br>
                            â€¢ ãƒãƒƒãƒå‡¦ç†ã«ã‚ˆã‚‹åŠ¹ç‡çš„å®Ÿè¡Œ: å®Œäº†
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³è¡¨ç¤ºé–¢æ•°
        function displayCsvDownloadButton(csvFilePath, reportType, testCaseCount, batchId) {
            try {
                console.log('ğŸ“ [Debug] Displaying CSV download button:', {
                    csvFilePath,
                    reportType,
                    testCaseCount,
                    batchId
                });
                
                // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’æ¢ã™
                let downloadContainer = document.getElementById('csvDownloadContainer');
                if (!downloadContainer) {
                    // ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
                    downloadContainer = document.createElement('div');
                    downloadContainer.id = 'csvDownloadContainer';
                    downloadContainer.style.cssText = 'margin-top: 15px; padding: 15px; background: #e8f5e8; border-radius: 8px; border: 2px solid #28a745;';
                    
                    // ãƒ­ã‚°ã‚¨ãƒªã‚¢ã®å¾Œã«æŒ¿å…¥
                    const logArea = document.getElementById('logArea');
                    if (logArea && logArea.parentNode) {
                        logArea.parentNode.insertBefore(downloadContainer, logArea.nextSibling);
                    }
                }
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®HTML
                const buttonHTML = `
                    <div style="text-align: center;">
                        <h5 style="color: #28a745; margin-bottom: 15px;">ğŸ“ CSVãƒ¬ãƒãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h5>
                        <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                            <div style="font-size: 14px; margin-bottom: 10px;">
                                <strong>ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${csvFilePath}<br>
                                <strong>ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥:</strong> ${reportType === 'batch' ? 'ãƒãƒƒãƒãƒ†ã‚¹ãƒˆçµæœ' : 'æ¨™æº–ãƒ†ã‚¹ãƒˆçµæœ'}<br>
                                <strong>ğŸ”¢ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ•°:</strong> ${testCaseCount}ä»¶<br>
                                <strong>ğŸ†” ãƒãƒƒãƒID:</strong> ${batchId}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                            <button onclick="downloadCsvFile('${csvFilePath}')" 
                                    class="btn btn-success" 
                                    style="padding: 15px 30px; font-size: 18px; font-weight: bold; min-width: 280px;">
                                ğŸ“¥ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                            ${batchId ? `
                            <button onclick="generateHTMLReport('${batchId}')" 
                                    style="background: #ffc107; color: black; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; min-width: 280px;">
                                ğŸ“„ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆHTMLã‚’è¡¨ç¤º
                            </button>
                            ` : ''}
                        </div>
                        ${batchId ? `
                        <div style="margin-top: 15px;">
                            <button onclick="loadBatchResultDetails('${batchId}')" 
                                    class="btn btn-info" 
                                    style="padding: 8px 16px; margin-right: 10px;">
                                ğŸ“Š ãƒãƒƒãƒçµæœè©³ç´°ã‚’è¡¨ç¤º
                            </button>
                            <button onclick="showStoryMapping('${batchId}')" 
                                    class="btn btn-primary" 
                                    style="padding: 8px 16px;">
                                ğŸ”— ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘ã‚’è¡¨ç¤º
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                downloadContainer.innerHTML = buttonHTML;
                downloadContainer.style.display = 'block';
                
                // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                downloadContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                console.log('ğŸ“ [Debug] CSV download button displayed successfully');
                
            } catch (error) {
                console.error('CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                addLog(`âŒ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã«å¤±æ•—: ${error.message}`);
            }
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•°
        async function downloadCsvFile(filename) {
            try {
                console.log('ğŸ“¥ [Debug] Starting CSV download:', filename);
                addLog(`ğŸ“¥ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­: ${filename}`);
                
                const response = await fetch(`/api/download-csv/${encodeURIComponent(filename)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/csv,application/csv,*/*'
                    }
                });
                
                console.log('ğŸ“¥ [Debug] Download response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${response.status} ${response.statusText}`);
                }
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’Blobã¨ã—ã¦å–å¾—
                const blob = await response.blob();
                console.log('ğŸ“¥ [Debug] Blob size:', blob.size, 'type:', blob.type);
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®URLã‚’ä½œæˆ
                const downloadUrl = window.URL.createObjectURL(blob);
                
                // ä¸€æ™‚çš„ãªãƒªãƒ³ã‚¯è¦ç´ ã‚’ä½œæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // URLã‚’è§£æ”¾
                window.URL.revokeObjectURL(downloadUrl);
                
                addLog(`âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ: ${filename}`);
                console.log('ğŸ“¥ [Debug] CSV download completed successfully');
                
            } catch (error) {
                console.error('CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                addLog(`âŒ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥ãƒªãƒ³ã‚¯ã‚’é–‹ã
                try {
                    window.open(`/api/download-csv/${encodeURIComponent(filename)}`, '_blank');
                    addLog(`ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ–°ã—ã„ã‚¿ãƒ–ã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã—ãŸ`);
                } catch (fallbackError) {
                    addLog(`âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å¤±æ•—ã—ã¾ã—ãŸ: ${fallbackError.message}`);
                }
            }
        }

        // ãƒãƒƒãƒçµæœã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦å¤±æ•—ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
        async function checkBatchResults() {
            try {
                const response = await fetch('/api/get-latest-batch-result');
                const result = await response.json();
                
                if (result.success && result.batchResult) {
                    const batchData = result.batchResult;
                    let hasFailures = false;
                    let totalSteps = 0;
                    let failedSteps = 0;
                    
                    // å„ãƒ«ãƒ¼ãƒˆã®çµæœã‚’ãƒã‚§ãƒƒã‚¯
                    if (batchData.results && Array.isArray(batchData.results)) {
                        batchData.results.forEach(route => {
                            if (route.step_results && Array.isArray(route.step_results)) {
                                totalSteps += route.step_results.length;
                                const failed = route.step_results.filter(step => step.status === 'failed').length;
                                failedSteps += failed;
                                if (failed > 0) {
                                    hasFailures = true;
                                }
                            }
                        });
                    }
                    
                    return {
                        hasFailures,
                        totalSteps,
                        failedSteps,
                        successRate: totalSteps > 0 ? Math.round(((totalSteps - failedSteps) / totalSteps) * 100) : 0,
                        batchId: batchData.batch_id
                    };
                }
                
                return null;
            } catch (error) {
                console.error('ãƒãƒƒãƒçµæœãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        // HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–¢æ•°
        async function generateHTMLReport(batchId) {
            try {
                addLog(`ğŸ“„ HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­... (ID: ${batchId})`);
                
                // HTMLãƒ¬ãƒãƒ¼ãƒˆç”ŸæˆAPIå‘¼ã³å‡ºã—
                const response = await fetch('/api/generate-html-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        batchId: batchId,
                        reportType: 'detailed'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå¤±æ•—: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(`âœ… HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: ${result.htmlFileName}`);
                    
                    // HTMLãƒ¬ãƒãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»è¡¨ç¤ºãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    showHTMLReportOptions(result.htmlFileName, batchId);
                    
                } else {
                    throw new Error(result.error || 'HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                addLog(`âŒ HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                console.error('HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // HTMLãƒ¬ãƒãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤ºé–¢æ•°
        function showHTMLReportOptions(htmlFileName, batchId) {
            const optionsHtml = `
                <div id="htmlReportOptions" style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 10px; border: 2px solid #ffc107;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #856404; margin: 0;">ğŸ“„ HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†</h4>
                        <button onclick="document.getElementById('htmlReportOptions').remove()" 
                                style="background: none; border: none; font-size: 20px; cursor: pointer; color: #6c757d;">
                            âœ•
                        </button>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <div style="font-size: 14px; margin-bottom: 10px;">
                            <strong>ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${htmlFileName}<br>
                            <strong>ğŸ†” ãƒãƒƒãƒID:</strong> ${batchId}<br>
                            <strong>ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥:</strong> è©³ç´°HTMLãƒ¬ãƒãƒ¼ãƒˆ
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button onclick="downloadHTMLFile('${htmlFileName}')" 
                                style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin-right: 15px; font-weight: bold;">
                            ğŸ“¥ HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </button>
                        <button onclick="viewHTMLInNewTab('${htmlFileName}')" 
                                style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                            ğŸ‘ï¸ åˆ¥ã‚¿ãƒ–ã§è¡¨ç¤º
                        </button>
                    </div>
                </div>
            `;
            
            // æ—¢å­˜ã®HTMLãƒ¬ãƒãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤
            const existingOptions = document.getElementById('htmlReportOptions');
            if (existingOptions) {
                existingOptions.remove();
            }
            
            // ãƒãƒƒãƒçµæœè©³ç´°ã®å¾Œã«æŒ¿å…¥
            const batchDetails = document.getElementById('batchResultDetails');
            if (batchDetails) {
                batchDetails.insertAdjacentHTML('afterend', optionsHtml);
            } else {
                // ãƒãƒƒãƒçµæœè©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼ã®å¾Œã«æŒ¿å…¥
                const testSummary = document.getElementById('testSummary');
                if (testSummary) {
                    testSummary.insertAdjacentHTML('afterend', optionsHtml);
                }
            }
            
            // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                document.getElementById('htmlReportOptions').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }, 100);
        }

        // HTMLãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•°
        async function downloadHTMLFile(htmlFileName) {
            try {
                addLog(`ğŸ“¥ HTMLãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­: ${htmlFileName}`);
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
                const downloadUrl = `/api/download-html/${encodeURIComponent(htmlFileName)}`;
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = htmlFileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addLog(`âœ… HTMLãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${htmlFileName}`);
                
            } catch (error) {
                addLog(`âŒ HTMLãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                console.error('HTMLãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // HTMLåˆ¥ã‚¿ãƒ–è¡¨ç¤ºé–¢æ•°
        function viewHTMLInNewTab(htmlFileName) {
            try {
                addLog(`ğŸ‘ï¸ HTMLãƒ¬ãƒãƒ¼ãƒˆã‚’åˆ¥ã‚¿ãƒ–ã§è¡¨ç¤º: ${htmlFileName}`);
                
                // åˆ¥ã‚¿ãƒ–ã§HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
                const viewUrl = `/api/view-html/${encodeURIComponent(htmlFileName)}`;
                window.open(viewUrl, '_blank');
                
                addLog(`âœ… HTMLãƒ¬ãƒãƒ¼ãƒˆåˆ¥ã‚¿ãƒ–è¡¨ç¤ºå®Œäº†: ${htmlFileName}`);
                
            } catch (error) {
                addLog(`âŒ HTMLåˆ¥ã‚¿ãƒ–è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
                console.error('HTMLåˆ¥ã‚¿ãƒ–è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }
    </script>

    <!-- ãƒãƒƒãƒçµæœè©³ç´°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="batchResultDetails" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid #007bff;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="color: #007bff; margin: 0;">ğŸ“Š ãƒãƒƒãƒçµæœè©³ç´°</h4>
            <button onclick="document.getElementById('batchResultDetails').style.display='none'" 
                    style="background: none; border: none; font-size: 20px; cursor: pointer; color: #6c757d;">
                âœ•
            </button>
        </div>
        <div id="detailsContent">
            <!-- ãƒãƒƒãƒçµæœè©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="storyMappingArea" style="display: none; margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 10px; border: 2px solid #ffc107;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="color: #856404; margin: 0;">ğŸ”— ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘</h4>
            <button onclick="document.getElementById('storyMappingArea').style.display='none'" 
                    style="background: none; border: none; font-size: 20px; cursor: pointer; color: #6c757d;">
                âœ•
            </button>
        </div>
        <div id="storyMappingContent">
            <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç´ä»˜ã‘æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

</body>
</html>